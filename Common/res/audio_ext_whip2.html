<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>çº¯éŸ³é¢‘ WHIP/WHEP ç§’å¼€ + Trickle ICE æµ‹è¯•</title>
</head>
<body>
<h3>çº¯éŸ³é¢‘ç›´æ’­ï¼ˆç§’å¼€æ’­æ”¾ï¼‰</h3>
<button id="btnPublish">å¼€å§‹æ¨é€å¹¶æ’­æ”¾</button>
<br><br>
<audio id="audioPlayer" autoplay controls></audio>

<script>
const BASE = 'https://47.100.126.194'; // æ”¹æˆä½ çš„ SRS åœ°å€ï¼ˆå»ºè®® httpsï¼‰
const APP = 'live';
const STREAM = 'audio_' + Date.now();
const WHIP_URL = `${BASE}/rtc/v1/whip/?app=${APP}&stream=${STREAM}`;
const WHEP_URL = `${BASE}/rtc/v1/whep/?app=${APP}&stream=${STREAM}`;

// å¦‚æœåŒç½‘ç»œæµ‹è¯•ï¼Œä¸ºäº†é¿å… STUN è¶…æ—¶ï¼Œå…ˆç¦ç”¨ STUN
const iceServers = []; 
// æˆ–å…¬ç½‘æµ‹è¯•æ—¶ç”¨ STUN
// const iceServers = [{ urls: ['stun:stun.l.google.com:19302'] }];

// Trickle å‘é€å€™é€‰
function setupTrickle(pc, trickleUrl) {
    pc.onicecandidate = async e => {
        if (e.candidate) {
            console.log("ğŸ“¡ Trickle ICE candidate:", e.candidate.candidate);
            try {
                await fetch(trickleUrl, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/trickle-ice-sdpfrag' },
                    body: 'a=' + e.candidate.candidate
                });
            } catch (err) {
                console.warn("âš ï¸ å‘é€å€™é€‰å¤±è´¥:", err);
            }
        } else {
            console.log("âœ… ICEå€™é€‰æ”¶é›†å®Œæˆ");
        }
    };
}

// æ¨éŸ³é¢‘
async function whipPublishAudio() {
    console.log("ğŸ“¤ æ¨æµç«¯å¼€å§‹æ¡æ‰‹...");
    const pc = new RTCPeerConnection({ iceServers, sdpSemantics: 'unified-plan' });
    setupTrickle(pc, WHIP_URL);

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    stream.getTracks().forEach(track => pc.addTrack(track, stream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    // ä¸ç­‰ ICE å®Œæˆï¼Œç«‹å³å‘é€ SDP
    const res = await fetch(WHIP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/sdp' },
        body: pc.localDescription.sdp
    });
    const answerSdp = await res.text();
    await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });

    console.log("âœ… æ¨æµç«¯å‡†å¤‡å®Œæ¯•");
    window._pubPc = pc;
}

// æ’­éŸ³é¢‘
async function whepPlayAudio() {
    console.log("ğŸ“¥ æ’­æ”¾ç«¯å¼€å§‹æ¡æ‰‹...");
    const pc = new RTCPeerConnection({ iceServers, sdpSemantics: 'unified-plan' });
    setupTrickle(pc, WHEP_URL);

    pc.ontrack = event => {
        console.log("ğŸ§ æ”¶åˆ°éŸ³é¢‘è½¨é“", event.streams);
        const audioElem = document.getElementById('audioPlayer');
        if (!audioElem.srcObject) {
            audioElem.srcObject = event.streams[0];
        }
    };

    pc.addTransceiver('audio', { direction: 'recvonly' });

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    const res = await fetch(WHEP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/sdp' },
        body: pc.localDescription.sdp
    });
    const answerSdp = await res.text();
    await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });

    console.log("âœ… æ’­æ”¾ç«¯å‡†å¤‡å®Œæ¯•");
    window._subPc = pc;
}

// æŒ‰é’®ï¼šæ¨å®Œç«‹å³æ’­
document.getElementById('btnPublish').onclick = async () => {
    try {
        await whipPublishAudio();
        await whepPlayAudio();
    } catch (e) {
        console.error('âŒ å¤±è´¥:', e);
        alert('å¤±è´¥ï¼š' + e.message);
    }
};
</script>
</body>
</html>
