<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>çº¯éŸ³é¢‘ WHIP/WHEP æµ‹è¯•</title>
</head>
<body>
<h3>çº¯éŸ³é¢‘ç›´æ’­æµ‹è¯•</h3>
<button id="btnPublish">å¼€å§‹æ¨é€éŸ³é¢‘å¹¶æ’­æ”¾</button>
<br><br>
<audio id="audioPlayer" autoplay controls></audio>

<script>
const BASE = 'https://47.100.126.194'; // æ›¿æ¢æˆä½ çš„å…¬ç½‘IPæˆ–åŸŸå
const APP = 'live';
const STREAM = 'audio_' + Date.now(); // è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€æµå
const WHIP_URL = `${BASE}/rtc/v1/whip/?app=${APP}&stream=${STREAM}`;
const WHEP_URL = `${BASE}/rtc/v1/whep/?app=${APP}&stream=${STREAM}`;
const iceServers = [{ urls: ['stun:stun.l.google.com:19302'] }];

// ç­‰ ICE å®Œæˆ
async function gatherComplete(pc) {
    if (pc.iceGatheringState === 'complete') return;
    await new Promise(resolve => {
        const checkState = () => {
            if (pc.iceGatheringState === 'complete') {
                pc.removeEventListener('icegatheringstatechange', checkState);
                resolve();
            }
        };
        pc.addEventListener('icegatheringstatechange', checkState);
    });
}

// æ¨é€éŸ³é¢‘
async function whipPublishAudio() {
    console.log("í ½í³¤ å¼€å§‹ WHIP éŸ³é¢‘æ¨æµ...");
    const pc = new RTCPeerConnection({ iceServers, sdpSemantics: 'unified-plan' });
    window._pubPc = pc;

    // åªé‡‡é›†éŸ³é¢‘ï¼Œä¸é‡‡è§†é¢‘
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    console.log("í ¼í¾¤ å·²è·å–éº¦å…‹é£éŸ³é¢‘æµ", stream);

    stream.getTracks().forEach(track => {
        console.log("â• æ·»åŠ éŸ³é¢‘è½¨é“", track);
        pc.addTrack(track, stream);
    });

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await gatherComplete(pc);

    const res = await fetch(WHIP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/sdp' },
        body: pc.localDescription.sdp
    });
    if (!res.ok) throw new Error('WHIP HTTP é”™è¯¯: ' + res.status);

    const answerSdp = await res.text();
    await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });
    console.log("âœ… WHIP éŸ³é¢‘æ¨æµæˆåŠŸ");
}

// æ’­æ”¾éŸ³é¢‘
async function whepPlayAudio() {
    console.log("í ½í³¥ å¼€å§‹ WHEP éŸ³é¢‘æ’­æ”¾...");
    const pc = new RTCPeerConnection({ iceServers, sdpSemantics: 'unified-plan' });
    window._subPc = pc;

    pc.ontrack = event => {
        console.log("í ½í³¡ æ”¶åˆ°éŸ³é¢‘æµ ontrack", event.streams);
        const audioElem = document.getElementById('audioPlayer');
        if (!audioElem.srcObject) {
            audioElem.srcObject = event.streams[0];
            console.log("í ¼í¾§ å·²ç»‘å®šéŸ³é¢‘æµåˆ° <audio> æ ‡ç­¾");
        }
    };

    // æ’­æ”¾ç«¯åªæ¥æ”¶éŸ³é¢‘
    pc.addTransceiver('audio', { direction: 'recvonly' });

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
    await gatherComplete(pc);

    const res = await fetch(WHEP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/sdp' },
        body: pc.localDescription.sdp
    });
    if (!res.ok) throw new Error('WHEP HTTP é”™è¯¯: ' + res.status);

    const answerSdp = await res.text();
    await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });
    console.log("âœ… WHEP éŸ³é¢‘æ’­æ”¾æˆåŠŸ");
}

// æŒ‰é’®ï¼šå…ˆæ¨æµï¼Œ2ç§’åæ’­æ”¾
document.getElementById('btnPublish').onclick = async () => {
    try {
        await whipPublishAudio();
        setTimeout(whepPlayAudio, 2000);
    } catch (e) {
        console.error('âŒ æ“ä½œå¤±è´¥', e);
        alert('å¤±è´¥ï¼š' + e.message);
    }
};
</script>
</body>
</html>

