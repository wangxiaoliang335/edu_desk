<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>å¯¹è®²</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
			background: rgba(0, 0, 0, 0.3);
			backdrop-filter: blur(10px);
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			padding: 20px;
		}
		
		.container {
			width: 90%;
			max-width: 800px;
			background: #3C3C3C;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
		}
		
		.header {
			background: #2C2C2C;
			padding: 15px 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			border-bottom: 1px solid #4C4C4C;
		}
		
		.header-title {
			display: flex;
			align-items: center;
			gap: 10px;
			color: white;
			font-size: 18px;
			font-weight: 500;
		}
		
		.close-btn {
			background: none;
			border: none;
			color: white;
			font-size: 24px;
			cursor: pointer;
			padding: 0;
			width: 30px;
			height: 30px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.close-btn:hover {
			background: rgba(255, 255, 255, 0.1);
			border-radius: 4px;
		}
		
		.header-buttons {
			display: flex;
			gap: 10px;
		}
		
		.btn {
			background: #4C4C4C;
			border: none;
			color: white;
			padding: 8px 16px;
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
			transition: background 0.2s;
		}
		
		.btn:hover {
			background: #5C5C5C;
		}
		
		.connection-status {
			padding: 10px 20px;
			color: #ffeb3b;
			font-size: 12px;
			background: #2C2C2C;
			border-bottom: 1px solid #4C4C4C;
		}
		
		.participants-section {
			padding: 20px;
			border-bottom: 1px solid #4C4C4C;
		}
		
		.participants-title {
			color: white;
			font-size: 14px;
			margin-bottom: 15px;
		}
		
		.participants-list {
			display: flex;
			gap: 15px;
			overflow-x: auto;
			padding-bottom: 10px;
		}
		
		.participant {
			flex-shrink: 0;
			text-align: center;
			cursor: pointer;
		}
		
		.participant-avatar {
			width: 70px;
			height: 70px;
			border-radius: 8px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-size: 24px;
			margin-bottom: 8px;
			border: 3px solid transparent;
			transition: border 0.2s;
		}
		
		.participant.active .participant-avatar {
			border-color: #007AFF;
		}
		
		.participant-name {
			color: white;
			font-size: 12px;
			max-width: 70px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}
		
		.chat-section {
			padding: 20px;
			max-height: 400px;
			overflow-y: auto;
			border-bottom: 1px solid #4C4C4C;
		}
		
		.message {
			display: flex;
			gap: 12px;
			margin-bottom: 20px;
		}
		
		.message-avatar {
			width: 40px;
			height: 40px;
			border-radius: 50%;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			flex-shrink: 0;
		}
		
		.message-content {
			flex: 1;
		}
		
		.message-header {
			display: flex;
			gap: 8px;
			align-items: center;
			margin-bottom: 5px;
		}
		
		.message-sender {
			color: #9E9E9E;
			font-size: 13px;
			font-weight: 500;
		}
		
		.message-bubble {
			background: #4C4C4C;
			color: white;
			padding: 10px 15px;
			border-radius: 8px;
			font-size: 14px;
			line-height: 1.5;
			max-width: 70%;
		}
		
		.input-section {
			padding: 15px 20px;
			display: flex;
			gap: 10px;
			align-items: center;
		}
		
		.input-field {
			flex: 1;
			background: #4C4C4C;
			border: none;
			color: white;
			padding: 12px 15px;
			border-radius: 8px;
			font-size: 14px;
			outline: none;
		}
		
		.input-field::placeholder {
			color: #9E9E9E;
		}
		
		.voice-btn {
			width: 50px;
			height: 50px;
			border-radius: 50%;
			background: #007AFF;
			border: none;
			color: white;
			font-size: 20px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: background 0.2s;
		}
		
		.voice-btn:hover {
			background: #0056CC;
		}
		
		.voice-btn::before {
			content: "ğŸ”Š";
		}
		
		/* æ»šåŠ¨æ¡æ ·å¼ */
		.chat-section::-webkit-scrollbar {
			width: 6px;
		}
		
		.chat-section::-webkit-scrollbar-track {
			background: #2C2C2C;
		}
		
		.chat-section::-webkit-scrollbar-thumb {
			background: #5C5C5C;
			border-radius: 3px;
		}
		
		.participants-list::-webkit-scrollbar {
			height: 6px;
		}
		
		.participants-list::-webkit-scrollbar-track {
			background: #2C2C2C;
		}
		
		.participants-list::-webkit-scrollbar-thumb {
			background: #5C5C5C;
			border-radius: 3px;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<div class="header-title">
				<span class="close-btn" onclick="window.close()">Ã—</span>
				<span>å¯¹è®²</span>
			</div>
			<div class="header-buttons">
				<button class="btn">é™éŸ³</button>
				<button class="btn">å•ç‹¬</button>
			</div>
		</div>
		<div id="connectionStatus" class="connection-status">
			æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...
		</div>
		
		<div class="participants-section">
			<div class="participants-title">å‚ä¸è€…</div>
			<div class="participants-list" id="participantsList">
				<!-- å‚ä¸è€…åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
			</div>
		</div>
		
		<div class="chat-section" id="chatSection">
			<div class="message">
				<div class="message-avatar"></div>
				<div class="message-content">
					<div class="message-header">
						<span class="message-sender">ç­ä¸»ä»»</span>
					</div>
					<div class="message-bubble">æè€å¸ˆ,ä»Šå¤©å®¶é‡Œæœ‰äº‹,æˆ‘ä»¬è°ƒä¸€ä¸‹è¯¾å§</div>
				</div>
			</div>
			<div class="message">
				<div class="message-avatar"></div>
				<div class="message-content">
					<div class="message-header">
						<span class="message-sender">è¯­æ–‡è€å¸ˆ</span>
					</div>
					<div class="message-bubble">å¯ä»¥</div>
				</div>
			</div>
		</div>
		
		<div class="input-section">
			<input type="text" class="input-field" placeholder="è¯·è¾“å…¥æ–‡å­—...">
			<button class="voice-btn"></button>
		</div>
	</div>
	
	<script>
		// ä»C++ä¼ å…¥çš„æˆå‘˜æ•°æ® - ä½¿ç”¨å ä½ç¬¦ {{DATA_PLACEHOLDER}}
		console.log('åŸå§‹æ•°æ®å ä½ç¬¦:', '{{DATA_PLACEHOLDER}}');
		const appData = JSON.parse('{{DATA_PLACEHOLDER}}');
		console.log('è§£æåçš„appData:', appData);
		const membersData = appData.members || [];
		const currentUser = appData.current_user || {};
		const groupId = appData.group_id || '';  // ç­çº§ç¾¤çš„å”¯ä¸€ç¼–å·
		console.log('å½“å‰ç”¨æˆ·ä¿¡æ¯:', currentUser);
		console.log('ç”¨æˆ·IDå€¼:', currentUser.id, 'ç±»å‹:', typeof currentUser.id);
		console.log('ç­çº§ç¾¤å”¯ä¸€ç¼–å·:', groupId);
		
		// WebSocketè¿æ¥
		let ws = null;
		let roomId = null;
		
		// SRS WHIP éŸ³é¢‘æ¨é€é…ç½®
		const BASE = 'https://47.100.126.194'; // SRSæœåŠ¡å™¨åœ°å€
		const APP = 'live';
		const iceServers = [{ urls: ['stun:stun.l.google.com:19302'] }];
		let publishPc = null; // æ¨é€éŸ³é¢‘çš„ PeerConnection
		
		// æ¸²æŸ“å‚ä¸è€…åˆ—è¡¨
		function renderParticipants() {
			const list = document.getElementById('participantsList');
			list.innerHTML = '';
			
			if (membersData && Array.isArray(membersData)) {
				membersData.forEach((member, index) => {
					const participant = document.createElement('div');
					participant.className = 'participant' + (index === 0 ? ' active' : '');
					
					const avatar = document.createElement('div');
					avatar.className = 'participant-avatar';
					// ä½¿ç”¨åå­—çš„é¦–å­—ç¬¦ä½œä¸ºå¤´åƒ
					avatar.textContent = member.name ? member.name.charAt(0) : '?';
					
					const name = document.createElement('div');
					name.className = 'participant-name';
					name.textContent = member.name || member.id;
					name.title = member.id + ' - ' + member.name;
					
					participant.appendChild(avatar);
					participant.appendChild(name);
					
					participant.addEventListener('click', () => {
						// ç§»é™¤æ‰€æœ‰activeç±»
						document.querySelectorAll('.participant').forEach(p => p.classList.remove('active'));
						// æ·»åŠ activeç±»åˆ°å½“å‰å‚ä¸è€…
						participant.classList.add('active');
					});
					
					list.appendChild(participant);
				});
			}
		}
		
		// è¿æ¥WebSocket
		function connectWebSocket() {
			// è¯¦ç»†è°ƒè¯•ä¿¡æ¯
			console.log('=== connectWebSocket è¢«è°ƒç”¨ ===');
			console.log('currentUser:', currentUser);
			console.log('currentUser.id:', currentUser.id);
			console.log('currentUser.id ç±»å‹:', typeof currentUser.id);
			console.log('currentUser å®Œæ•´å¯¹è±¡:', JSON.stringify(currentUser));
			
			// WebSocket URLéœ€è¦åŒ…å«ç”¨æˆ·IDï¼Œæ ¼å¼: ws://47.100.126.194:5000/ws/{ç”¨æˆ·ID}
			const userId = (currentUser.id || '').toString().trim();
			console.log('å¤„ç†åçš„userId:', userId);
			console.log('userIdé•¿åº¦:', userId.length);
			
			if (!userId) {
				console.error('æ— æ³•è¿æ¥WebSocketï¼šç¼ºå°‘ç”¨æˆ·ID');
				console.error('currentUserå®Œæ•´å¯¹è±¡:', JSON.stringify(currentUser));
				console.error('appDataå®Œæ•´å¯¹è±¡:', JSON.stringify(appData));
				alert('é”™è¯¯ï¼šæ— æ³•è·å–ç”¨æˆ·IDï¼\nè¯·æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®ä¼ é€’ã€‚\n\ncurrentUser: ' + JSON.stringify(currentUser));
				return;  // é‡è¦ï¼šå¦‚æœç”¨æˆ·IDä¸ºç©ºï¼Œä¸è¿æ¥WebSocket
			}
			
			// å†æ¬¡éªŒè¯userIdä¸ä¸ºç©º
			if (!userId || userId.length === 0) {
				console.error('ä¸¥é‡é”™è¯¯ï¼šuserIdä»ç„¶ä¸ºç©ºï¼Œä¸åº”è¯¥åˆ°è¾¾è¿™é‡Œï¼');
				return;
			}
			
			const wsUrl = 'ws://47.100.126.194:5000/ws/' + encodeURIComponent(userId);
			console.log('æ­£åœ¨è¿æ¥WebSocket:', wsUrl);
			console.log('ç”¨æˆ·ID:', userId);
			console.log('ç¼–ç åçš„ç”¨æˆ·ID:', encodeURIComponent(userId));
			console.log('å®Œæ•´WebSocket URL:', wsUrl);
			
			const statusInfo = document.getElementById('connectionStatus');
			if (statusInfo) {
				statusInfo.textContent = `å½“å‰ç”¨æˆ·ID: ${userId}ï¼ŒWebSocket: ${wsUrl}`;
			}
			
			// åˆ›å»ºWebSocketè¿æ¥
			console.log('å‡†å¤‡åˆ›å»ºWebSocketè¿æ¥...');
			ws = new WebSocket(wsUrl);
			console.log('WebSocketå¯¹è±¡å·²åˆ›å»ºï¼ŒçŠ¶æ€:', ws.readyState);
			
			ws.onopen = function() {
				console.log('WebSocketè¿æ¥å·²å»ºç«‹');
				// è¿æ¥æˆåŠŸåå‘é€åˆ›å»ºæˆ¿é—´æ¶ˆæ¯
				createRoom();
			};
			
			ws.onmessage = function(event) {
				console.log('========================================');
				console.log('ğŸ“¥ æ”¶åˆ°WebSocketæ¶ˆæ¯:');
				console.log('åŸå§‹æ•°æ®:', event.data);
				console.log('æ•°æ®ç±»å‹:', typeof event.data);
				console.log('æ•°æ®é•¿åº¦:', event.data ? event.data.length : 0);
				
				try {
					const message = JSON.parse(event.data);
					console.log('è§£æåçš„æ¶ˆæ¯å¯¹è±¡:', message);
					console.log('æ¶ˆæ¯ç±»å‹:', message.type);
					console.log('å®Œæ•´æ¶ˆæ¯å†…å®¹:', JSON.stringify(message, null, 2));
					console.log('========================================');
					
					handleWebSocketMessage(message);
				} catch (e) {
					console.error('âŒ è§£æWebSocketæ¶ˆæ¯å¤±è´¥:');
					console.error('é”™è¯¯:', e);
					console.error('åŸå§‹æ•°æ®:', event.data);
					console.error('========================================');
				}
			};
			
			ws.onerror = function(error) {
				console.error('WebSocketé”™è¯¯:', error);
				// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
				const chatSection = document.getElementById('chatSection');
				if (chatSection) {
					const errorMsg = document.createElement('div');
					errorMsg.className = 'message';
					errorMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #f44336; color: white;">âš ï¸ WebSocketè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜</div></div>';
					chatSection.appendChild(errorMsg);
				}
			};
			
			ws.onclose = function(event) {
				console.log('WebSocketè¿æ¥å·²å…³é—­', 'ä»£ç :', event.code, 'åŸå› :', event.reason);
				// å¦‚æœæ˜¯å› ä¸º403é”™è¯¯å…³é—­ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
				if (event.code === 1006 || event.code === 403) {
					const chatSection = document.getElementById('chatSection');
					if (chatSection) {
						const errorMsg = document.createElement('div');
						errorMsg.className = 'message';
						errorMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #f44336; color: white;">âŒ è¿æ¥è¢«æœåŠ¡å™¨æ‹’ç»ï¼ˆ403ï¼‰ï¼Œå¯èƒ½æ˜¯è®¤è¯å¤±è´¥</div></div>';
						chatSection.appendChild(errorMsg);
					}
				}
			};
		}
		
		// åˆ›å»ºæˆ¿é—´
		function createRoom() {
			console.log('=== createRoom å‡½æ•°è¢«è°ƒç”¨ ===');
			console.log('WebSocketçŠ¶æ€æ£€æŸ¥ - wså¯¹è±¡:', ws);
			console.log('WebSocketçŠ¶æ€æ£€æŸ¥ - readyState:', ws ? ws.readyState : 'wsä¸ºnull');
			
			if (!ws || ws.readyState !== WebSocket.OPEN) {
				console.error('âŒ WebSocketæœªè¿æ¥ï¼Œæ— æ³•åˆ›å»ºæˆ¿é—´');
				console.error('wså­˜åœ¨:', !!ws);
				console.error('readyState:', ws ? ws.readyState : 'N/A');
				console.error('WebSocket.OPENå¸¸é‡å€¼:', WebSocket.OPEN);
				return;
			}
			
			console.log('âœ… WebSocketè¿æ¥æ­£å¸¸ï¼Œå¼€å§‹åˆ›å»ºæˆ¿é—´');
			
			// ç”Ÿæˆæˆ¿é—´IDï¼ˆä½¿ç”¨æ—¶é—´æˆ³ï¼‰
			roomId = 'room_' + Date.now();
			console.log('ç”Ÿæˆæˆ¿é—´ID:', roomId);
			
			// éªŒè¯ç¾¤ç»„IDæ˜¯å¦å­˜åœ¨ï¼ˆåœ¨åˆ›å»ºæ¶ˆæ¯ä¹‹å‰éªŒè¯ï¼‰
			console.log('æ£€æŸ¥ç¾¤ç»„ID - groupIdå˜é‡:', groupId);
			console.log('æ£€æŸ¥ç¾¤ç»„ID - groupIdç±»å‹:', typeof groupId);
			console.log('æ£€æŸ¥ç¾¤ç»„ID - groupIdé•¿åº¦:', groupId ? groupId.length : 'undefined');
			console.log('æ£€æŸ¥ç¾¤ç»„ID - appData.group_id:', appData.group_id);
			
			if (!groupId || groupId.length === 0) {
				console.error('âŒ é”™è¯¯ï¼šç­çº§ç¾¤å”¯ä¸€ç¼–å·ä¸ºç©ºï¼Œæ— æ³•åˆ›å»ºä¸´æ—¶æˆ¿é—´ï¼');
				console.error('appDataå®Œæ•´å†…å®¹:', JSON.stringify(appData));
				const chatSection = document.getElementById('chatSection');
				if (chatSection) {
					const errorMsg = document.createElement('div');
					errorMsg.className = 'message';
					errorMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #f44336; color: white;">âŒ é”™è¯¯ï¼šç­çº§ç¾¤å”¯ä¸€ç¼–å·ä¸ºç©ºï¼Œæ— æ³•åˆ›å»ºä¸´æ—¶æˆ¿é—´ï¼</div></div>';
					chatSection.appendChild(errorMsg);
					chatSection.scrollTop = chatSection.scrollHeight;
				}
				return;
			}
			
			console.log('âœ… ç¾¤ç»„IDéªŒè¯é€šè¿‡:', groupId);
			
			// ç”Ÿæˆstream_urlï¼šä½¿ç”¨ç­çº§ç¾¤å”¯ä¸€ç¼–å·ä½œä¸ºstreamå‚æ•°
			// æ ¼å¼ï¼šhttps://47.100.126.194/rtc/v1/whep/?app=live&stream=<ç­çº§ç¾¤çš„å”¯ä¸€ç¼–å·>
			const streamUrl = `https://47.100.126.194/rtc/v1/whep/?app=live&stream=${groupId}`;
			console.log('ç”Ÿæˆstream_url:', streamUrl);
			console.log('streamå‚æ•°ï¼ˆç­çº§ç¾¤å”¯ä¸€ç¼–å·ï¼‰:', groupId);
			
			// æ„å»ºåˆ›å»ºæˆ¿é—´çš„æ¶ˆæ¯
			const createRoomMessage = {
				type: "6",
				invited_users: [],  // åˆå§‹ä¸ºç©ºæ•°ç»„
				stream_url: streamUrl,
				owner_name: currentUser.name || "ç”¨æˆ·",
				group_id: groupId  // ç­çº§ç¾¤çš„å”¯ä¸€ç¼–å·
			};
			
			console.log('ç­çº§ç¾¤å”¯ä¸€ç¼–å·:', groupId);
			console.log('ç­çº§ç¾¤å”¯ä¸€ç¼–å·é•¿åº¦:', groupId.length);
			
			console.log('========================================');
			console.log('ğŸ“¤ å‡†å¤‡å‘é€åˆ›å»ºæˆ¿é—´æ¶ˆæ¯:');
			console.log('å®Œæ•´æ¶ˆæ¯å¯¹è±¡:', createRoomMessage);
			console.log('æ¶ˆæ¯JSONå­—ç¬¦ä¸²:', JSON.stringify(createRoomMessage));
			console.log('group_idå­—æ®µå€¼:', createRoomMessage.group_id);
			console.log('========================================');
			
			try {
				// å‘é€æ¶ˆæ¯ï¼ˆç›´æ¥å‘é€JSONæ ¼å¼ï¼‰
				const messageString = JSON.stringify(createRoomMessage);
				ws.send(messageString);
				
				console.log('âœ… åˆ›å»ºæˆ¿é—´æ¶ˆæ¯å·²å‘é€æˆåŠŸï¼');
				console.log('å‘é€çš„æ¶ˆæ¯å­—ç¬¦ä¸²:', messageString);
				console.log('å‘é€æ—¶çš„WebSocketçŠ¶æ€:', ws.readyState);
				
				// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå‘é€æˆåŠŸçš„ä¿¡æ¯
				const chatSection = document.getElementById('chatSection');
				if (chatSection) {
					const successMsg = document.createElement('div');
					successMsg.className = 'message';
					successMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #4CAF50; color: white;">âœ… åˆ›å»ºæˆ¿é—´æ¶ˆæ¯å·²å‘é€: ' + roomId + '</div></div>';
					chatSection.appendChild(successMsg);
					chatSection.scrollTop = chatSection.scrollHeight;
				}
			} catch (error) {
				console.error('âŒ å‘é€åˆ›å»ºæˆ¿é—´æ¶ˆæ¯å¤±è´¥:', error);
				console.error('é”™è¯¯è¯¦æƒ…:', error.message);
				console.error('é”™è¯¯å †æ ˆ:', error.stack);
				
				// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå‘é€å¤±è´¥çš„ä¿¡æ¯
				const chatSection = document.getElementById('chatSection');
				if (chatSection) {
					const errorMsg = document.createElement('div');
					errorMsg.className = 'message';
					errorMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #f44336; color: white;">âŒ å‘é€åˆ›å»ºæˆ¿é—´æ¶ˆæ¯å¤±è´¥: ' + error.message + '</div></div>';
					chatSection.appendChild(errorMsg);
				}
			}
		}
		
		// ç­‰ ICE å®Œæˆï¼ˆä» audio_ext_whip.html æå–ï¼‰
		async function gatherComplete(pc) {
			if (pc.iceGatheringState === 'complete') return;
			await new Promise(resolve => {
				const checkState = () => {
					if (pc.iceGatheringState === 'complete') {
						pc.removeEventListener('icegatheringstatechange', checkState);
						resolve();
					}
				};
				pc.addEventListener('icegatheringstatechange', checkState);
			});
		}
		
		// æ¨é€éŸ³é¢‘åˆ°SRSæœåŠ¡å™¨ï¼ˆä» audio_ext_whip.html æå–ï¼‰
		async function whipPublishAudio() {
			console.log("ğŸ¤ å¼€å§‹ WHIP éŸ³é¢‘æ¨æµ...");
			
			if (!groupId || groupId.length === 0) {
				console.error('âŒ æ— æ³•æ¨é€éŸ³é¢‘ï¼šgroupId ä¸ºç©º');
				return;
			}
			
			// ä½¿ç”¨ groupId ä½œä¸º stream å‚æ•°
			const STREAM = groupId;
			const WHIP_URL = `${BASE}/rtc/v1/whip/?app=${APP}&stream=${STREAM}`;
			console.log('WHIP URL:', WHIP_URL);
			console.log('Streamå‚æ•°ï¼ˆç­çº§ç¾¤å”¯ä¸€ç¼–å·ï¼‰:', STREAM);
			
			try {
				const pc = new RTCPeerConnection({ iceServers, sdpSemantics: 'unified-plan' });
				publishPc = pc;
				window._pubPc = pc;

				// åªé‡‡é›†éŸ³é¢‘ï¼Œä¸é‡‡è§†é¢‘
				const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
				console.log("ğŸ¤ å·²è·å–éº¦å…‹é£éŸ³é¢‘æµ", stream);

				stream.getTracks().forEach(track => {
					console.log("â• æ·»åŠ éŸ³é¢‘è½¨é“", track);
					pc.addTrack(track, stream);
				});

				const offer = await pc.createOffer();
				await pc.setLocalDescription(offer);
				await gatherComplete(pc);

				const res = await fetch(WHIP_URL, {
					method: 'POST',
					headers: { 'Content-Type': 'application/sdp' },
					body: pc.localDescription.sdp
				});
				if (!res.ok) throw new Error('WHIP HTTP é”™è¯¯: ' + res.status);

				const answerSdp = await res.text();
				await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });
				console.log("âœ… WHIP éŸ³é¢‘æ¨æµæˆåŠŸ");
				
				// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
				const chatSection = document.getElementById('chatSection');
				if (chatSection) {
					const successMsg = document.createElement('div');
					successMsg.className = 'message';
					successMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #4CAF50; color: white;">âœ… éŸ³é¢‘æ¨æµæˆåŠŸï¼Stream: ' + STREAM + '</div></div>';
					chatSection.appendChild(successMsg);
					chatSection.scrollTop = chatSection.scrollHeight;
				}
			} catch (e) {
				console.error('âŒ WHIP éŸ³é¢‘æ¨æµå¤±è´¥', e);
				
				// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
				const chatSection = document.getElementById('chatSection');
				if (chatSection) {
					const errorMsg = document.createElement('div');
					errorMsg.className = 'message';
					errorMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #f44336; color: white;">âŒ éŸ³é¢‘æ¨æµå¤±è´¥: ' + e.message + '</div></div>';
					chatSection.appendChild(errorMsg);
					chatSection.scrollTop = chatSection.scrollHeight;
				}
			}
		}
		
		// å¤„ç†WebSocketæ¶ˆæ¯
		function handleWebSocketMessage(message) {
			console.log('========================================');
			console.log('ğŸ”” å¤„ç†WebSocketæ¶ˆæ¯:');
			console.log('æ¶ˆæ¯å¯¹è±¡:', message);
			console.log('æ¶ˆæ¯ç±»å‹:', message.type);
			console.log('æ¶ˆæ¯å®Œæ•´å†…å®¹:', JSON.stringify(message, null, 2));
			
			// è·å–èŠå¤©åŒºåŸŸå…ƒç´ ï¼ˆåœ¨å‡½æ•°å¼€å§‹å¤„å£°æ˜ä¸€æ¬¡ï¼‰
			const chatSection = document.getElementById('chatSection');
			
			// æ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œå¤„ç†
			if (message.type !== undefined) {
				console.log('æ¶ˆæ¯æœ‰typeå­—æ®µï¼Œå€¼ä¸º:', message.type);
				switch(String(message.type)) {
					case "room_created":
					case "6":
						console.log('âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸï¼');
						console.log('æˆ¿é—´ID:', message.room_id);
						if (message.room_id) {
							roomId = message.room_id;
							console.log('å·²æ›´æ–°roomIdå˜é‡ä¸º:', roomId);
							
							// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
							if (chatSection) {
								const successMsg = document.createElement('div');
								successMsg.className = 'message';
								successMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #4CAF50; color: white;">âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸï¼æˆ¿é—´ID: ' + message.room_id + '</div></div>';
								chatSection.appendChild(successMsg);
								chatSection.scrollTop = chatSection.scrollHeight;
							}
							
							// æˆ¿é—´åˆ›å»ºæˆåŠŸåï¼Œå¼€å§‹æ¨é€éŸ³é¢‘æ•°æ®åˆ°SRSæœåŠ¡å™¨
							console.log('ğŸ¤ æˆ¿é—´åˆ›å»ºæˆåŠŸï¼Œå¼€å§‹æ¨é€éŸ³é¢‘...');
							whipPublishAudio();
						}
						break;
					case "room_error":
					case "error":
						console.error('âŒ æˆ¿é—´åˆ›å»ºå¤±è´¥:');
						console.error('é”™è¯¯ä¿¡æ¯:', message.error || message.message);
						
						// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
						if (chatSection) {
							const errorMsg = document.createElement('div');
							errorMsg.className = 'message';
							errorMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #f44336; color: white;">âŒ æˆ¿é—´åˆ›å»ºå¤±è´¥: ' + (message.error || message.message || 'æœªçŸ¥é”™è¯¯') + '</div></div>';
							chatSection.appendChild(errorMsg);
							chatSection.scrollTop = chatSection.scrollHeight;
						}
						break;
					default:
						console.log('ğŸ“¨ æ”¶åˆ°å…¶ä»–ç±»å‹æ¶ˆæ¯:');
						console.log('ç±»å‹å€¼:', message.type);
						console.log('å®Œæ•´æ¶ˆæ¯:', message);
						
						// æ˜¾ç¤ºæ‰€æœ‰æ”¶åˆ°çš„æ¶ˆæ¯
						if (chatSection) {
							const infoMsg = document.createElement('div');
							infoMsg.className = 'message';
							infoMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #2196F3; color: white;">ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ' + JSON.stringify(message) + '</div></div>';
							chatSection.appendChild(infoMsg);
							chatSection.scrollTop = chatSection.scrollHeight;
						}
				}
			} else {
				console.log('âš ï¸ æ¶ˆæ¯æ²¡æœ‰typeå­—æ®µ:');
				console.log('å®Œæ•´æ¶ˆæ¯:', message);
				
				// æ˜¾ç¤ºæ²¡æœ‰typeçš„æ¶ˆæ¯
				if (chatSection) {
					const infoMsg = document.createElement('div');
					infoMsg.className = 'message';
					infoMsg.innerHTML = '<div class="message-content"><div class="message-bubble" style="background: #FF9800; color: white;">âš ï¸ æ”¶åˆ°æ— ç±»å‹æ¶ˆæ¯: ' + JSON.stringify(message) + '</div></div>';
					chatSection.appendChild(infoMsg);
					chatSection.scrollTop = chatSection.scrollHeight;
				}
			}
			
			console.log('========================================');
		}
		
		// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
		window.addEventListener('DOMContentLoaded', () => {
			console.log('åº”ç”¨æ•°æ®:', appData);
			console.log('å½“å‰ç”¨æˆ·:', currentUser);
			
			// æ¸²æŸ“å‚ä¸è€…åˆ—è¡¨
			renderParticipants();
			
			// è¿æ¥WebSocket
			connectWebSocket();
		});
		
		// é¡µé¢å…³é—­å‰å…³é—­WebSocketè¿æ¥å’ŒéŸ³é¢‘æ¨æµ
		window.addEventListener('beforeunload', () => {
			// åœæ­¢éŸ³é¢‘æ¨æµ
			if (publishPc) {
				publishPc.getSenders().forEach(sender => {
					if (sender.track) {
						sender.track.stop();
					}
				});
				publishPc.close();
				publishPc = null;
			}
			
			// å…³é—­WebSocketè¿æ¥
			if (ws) {
				ws.close();
			}
		});
	</script>
</body>
</html>

