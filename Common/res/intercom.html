<!DOCTYPE html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>å¯¹è®²</title>
	<style>
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
		}
		
		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
			background: rgba(0, 0, 0, 0.3);
			backdrop-filter: blur(10px);
			display: flex;
			justify-content: center;
			align-items: center;
			min-height: 100vh;
			padding: 20px;
		}
		
		.container {
			width: 90%;
			max-width: 800px;
			background: #3C3C3C;
			border-radius: 12px;
			overflow: hidden;
			box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
		}
		
		.header {
			background: #2C2C2C;
			padding: 15px 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			border-bottom: 1px solid #4C4C4C;
		}
		
		.header-title {
			display: flex;
			align-items: center;
			gap: 10px;
			color: white;
			font-size: 18px;
			font-weight: 500;
		}
		
		.close-btn {
			background: none;
			border: none;
			color: white;
			font-size: 24px;
			cursor: pointer;
			padding: 0;
			width: 30px;
			height: 30px;
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.close-btn:hover {
			background: rgba(255, 255, 255, 0.1);
			border-radius: 4px;
		}
		
		.header-buttons {
			display: flex;
			gap: 10px;
		}
		
		.btn {
			background: #4C4C4C;
			border: none;
			color: white;
			padding: 8px 16px;
			border-radius: 6px;
			cursor: pointer;
			font-size: 14px;
			transition: background 0.2s;
		}
		
		.btn:hover {
			background: #5C5C5C;
		}
		
		.connection-status {
			padding: 10px 20px;
			color: #ffeb3b;
			font-size: 12px;
			background: #2C2C2C;
			border-bottom: 1px solid #4C4C4C;
		}
		
		.participants-section {
			padding: 20px;
			border-bottom: 1px solid #4C4C4C;
		}
		
		.participants-title {
			color: white;
			font-size: 14px;
			margin-bottom: 15px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		.class-name-display {
			font-size: 12px;
			font-weight: normal;
			color: rgba(255, 255, 255, 0.7);
			margin-left: 10px;
		}
		
		.participants-list {
			display: flex;
			gap: 15px;
			overflow-x: auto;
			padding-bottom: 10px;
		}
		
		.participant {
			flex-shrink: 0;
			text-align: center;
			cursor: pointer;
			position: relative;
		}
		
		.participant-avatar {
			width: 70px;
			height: 70px;
			border-radius: 8px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			display: flex;
			align-items: center;
			justify-content: center;
			color: white;
			font-size: 24px;
			margin-bottom: 8px;
			border: 3px solid transparent;
			transition: border 0.2s;
			background-size: cover;
			background-position: center;
			background-repeat: no-repeat;
			position: relative;
			overflow: hidden;
		}
		
		.participant-avatar img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			border-radius: 8px;
			display: block;
		}
		
		/* å½“æœ‰å›¾ç‰‡æ—¶ï¼Œç§»é™¤èƒŒæ™¯æ¸å˜ */
		.participant-avatar:has(img) {
			background: transparent !important;
		}
		
		.participant.active .participant-avatar {
			border-color: #007AFF;
		}
		
		.participant.speaking .participant-avatar {
			border-color: #4CAF50;
			border-width: 4px;
			animation: speakingPulse 1.5s infinite;
		}
		
		@keyframes speakingPulse {
			0%, 100% {
				box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
			}
			50% {
				box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
			}
		}
		
		.speaking-indicator {
			position: absolute;
			top: -5px;
			right: -5px;
			width: 16px;
			height: 16px;
			background: #4CAF50;
			border-radius: 50%;
			border: 2px solid #3C3C3C;
			animation: speakingPulse 1.5s infinite;
		}
		
		.participant-name {
			color: white;
			font-size: 12px;
			max-width: 70px;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
		}
		
		.status-section {
			padding: 20px;
			border-bottom: 1px solid #4C4C4C;
		}
		
		.status-title {
			color: white;
			font-size: 14px;
			margin-bottom: 10px;
		}
		
		.status-log {
			max-height: 260px;
			overflow-y: auto;
			background: #2C2C2C;
			border: 1px solid #4C4C4C;
			border-radius: 8px;
			padding: 15px;
		}
		
		.status-entry {
			padding: 10px 12px;
			border-radius: 6px;
			font-size: 13px;
			line-height: 1.5;
			color: white;
			margin-bottom: 10px;
			background: rgba(255, 255, 255, 0.05);
		}
		
		.status-entry.info {
			border-left: 3px solid #2196F3;
		}
		
		.status-entry.success {
			border-left: 3px solid #4CAF50;
		}
		
		.status-entry.error {
			border-left: 3px solid #f44336;
		}
		
		.status-entry.warn {
			border-left: 3px solid #FF9800;
		}
		
		.voice-section {
			padding: 20px;
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 12px;
		}
		
		.voice-hint {
			color: #cccccc;
			font-size: 12px;
		}
		
		.voice-btn {
			width: 50px;
			height: 50px;
			border-radius: 50%;
			background: #007AFF;
			border: none;
			color: white;
			font-size: 20px;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: background 0.2s;
			user-select: none;
		}
		
		.voice-btn:hover {
			background: #0056CC;
		}
		
		.voice-btn.active {
			background: #f44336;
			animation: pulse 1s infinite;
		}
		
		.voice-btn.active::before {
			content: "ğŸ¤";
		}
		
		.voice-btn:not(.active)::before {
			content: "ğŸ”Š";
		}
		
		@keyframes pulse {
			0%, 100% {
				transform: scale(1);
			}
			50% {
				transform: scale(1.1);
			}
		}
		
		/* æ»šåŠ¨æ¡æ ·å¼ */
		.status-log::-webkit-scrollbar {
			width: 6px;
		}
		
		.status-log::-webkit-scrollbar-track {
			background: #2C2C2C;
		}
		
		.status-log::-webkit-scrollbar-thumb {
			background: #5C5C5C;
			border-radius: 3px;
		}
		
		.participants-list::-webkit-scrollbar {
			height: 6px;
		}
		
		.participants-list::-webkit-scrollbar-track {
			background: #2C2C2C;
		}
		
		.participants-list::-webkit-scrollbar-thumb {
			background: #5C5C5C;
			border-radius: 3px;
		}
	</style>
</head>
<body>
	<div class="container">
		<div class="header">
			<div class="header-title">
				<span class="close-btn" onclick="window.close()">Ã—</span>
				<span>å¯¹è®²</span>
			</div>
			<div class="header-buttons">
				<button class="btn">é™éŸ³</button>
				<button class="btn">å•ç‹¬</button>
			</div>
		</div>
		<div id="connectionStatus" class="connection-status">
			æ­£åœ¨è·å–ç”¨æˆ·ä¿¡æ¯...
		</div>
		
		<div class="participants-section">
			<div class="participants-title">
				<span>å‚ä¸è€…</span>
				<span id="classNameDisplay" class="class-name-display"></span>
			</div>
			<div class="participants-list" id="participantsList">
				<!-- å‚ä¸è€…åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
			</div>
		</div>
		
		<div class="status-section">
			<div class="status-title">è¯­éŸ³å¯¹è®²çŠ¶æ€</div>
			<div class="status-log" id="statusLog">
				<div class="status-entry info">âœ… æ­£åœ¨å‡†å¤‡è¯­éŸ³å¯¹è®²ï¼Œè¯·ç¨å€™...</div>
			</div>
		</div>
		
		<div class="voice-section">
			<button class="voice-btn"></button>
			<div class="voice-hint">æŒ‰ä½æŒ‰é’®å¼€å§‹å¯¹è®²ï¼Œæ¾å¼€æŒ‰é’®åœæ­¢</div>
		</div>
	</div>
	
	<script>
		// ä»C++ä¼ å…¥çš„æˆå‘˜æ•°æ® - ä½¿ç”¨å ä½ç¬¦ {{DATA_PLACEHOLDER}}
		console.log('åŸå§‹æ•°æ®å ä½ç¬¦:', '{{DATA_PLACEHOLDER}}');
		const appData = JSON.parse('{{DATA_PLACEHOLDER}}');
		console.log('è§£æåçš„appData:', appData);
		const membersData = appData.members || [];
		const currentUser = appData.current_user || {};
		const groupId = appData.group_id || '';  // ç­çº§ç¾¤çš„å”¯ä¸€ç¼–å·
		const className = appData.class_name || '';  // ç­çº§åç§°
		
		// æ˜¾ç¤ºç­çº§åç§°
		const classNameDisplay = document.getElementById('classNameDisplay');
		if (classNameDisplay && className) {
			classNameDisplay.textContent = className;
			console.log('ç­çº§åç§°:', className);
		}
		
		// ä» temp_room å¯¹è±¡ä¸­è¯»å–ä¸´æ—¶æˆ¿é—´ä¿¡æ¯ï¼ˆæ–°æ ¼å¼ï¼‰
		let roomId = null;
		let whipUrl = null;
		let whepUrl = null;
		let streamName = null;
		
		if (appData.temp_room && typeof appData.temp_room === 'object') {
			roomId = appData.temp_room.room_id || null;
			whipUrl = appData.temp_room.whip_url || null;
			whepUrl = appData.temp_room.whep_url || null;
			streamName = appData.temp_room.stream_name || null;
		} else {
			// å…¼å®¹æ—§æ ¼å¼ï¼šç›´æ¥ä» appData è¯»å– room_id
			roomId = appData.room_id || null;
		}
		
		console.log('å½“å‰ç”¨æˆ·ä¿¡æ¯:', currentUser);
		console.log('ç”¨æˆ·IDå€¼:', currentUser.id, 'ç±»å‹:', typeof currentUser.id);
		console.log('ç­çº§ç¾¤å”¯ä¸€ç¼–å·:', groupId);
		console.log('ä¸´æ—¶æˆ¿é—´ä¿¡æ¯:');
		console.log('  æˆ¿é—´ID:', roomId);
		console.log('  æ¨æµåœ°å€:', whipUrl);
		console.log('  æ‹‰æµåœ°å€:', whepUrl);
		console.log('  æµåç§°:', streamName);
		
		// WebSocketè¿æ¥
		let ws = null;
		const statusLog = document.getElementById('statusLog');
		
		// WebRTC é…ç½®
		const iceServers = [{ urls: ['stun:stun.l.google.com:19302'] }];
		let publishPc = null; // æ¨é€éŸ³é¢‘çš„ PeerConnection
		let publishStream = null; // æ¨æµæ–¹åª’ä½“æµ
		let subscribePc = null; // æ‹‰æµçš„ PeerConnection
		let subscribeStream = null; // æ‹‰æµæ–¹åª’ä½“æµ
		let roomInfo = null; // æˆ¿é—´ä¿¡æ¯
		
		function appendStatusMessage(message, type = 'info') {
			if (!statusLog) return;
			const entry = document.createElement('div');
			entry.className = `status-entry ${type}`;
			entry.textContent = `${new Date().toLocaleTimeString()}  ${message}`;
			statusLog.appendChild(entry);
			statusLog.scrollTop = statusLog.scrollHeight;
		}
		
		// å½“å‰è¯´è¯çš„ç”¨æˆ·ID
		let currentSpeakingUserId = null;
		
		// æ¸²æŸ“å‚ä¸è€…åˆ—è¡¨
		function renderParticipants() {
			const list = document.getElementById('participantsList');
			list.innerHTML = '';
			
			console.log('========== å¼€å§‹æ¸²æŸ“å‚ä¸è€…åˆ—è¡¨ ==========');
			console.log('æˆå‘˜æ•°æ®:', membersData);
			console.log('æˆå‘˜æ•°é‡:', membersData ? membersData.length : 0);
			console.log('å½“å‰ç”¨æˆ·:', currentUser);
			console.log('å½“å‰ç”¨æˆ·å¤´åƒ:', currentUser.icon);
			
			// ç¡®ä¿å½“å‰ç”¨æˆ·ä¹Ÿåœ¨å‚ä¸è€…åˆ—è¡¨ä¸­ï¼ˆå¦‚æœä¸åœ¨çš„è¯ï¼‰
			let allMembers = [...(membersData || [])];
			const currentUserInList = allMembers.find(m => m.id === currentUser.id);
			if (!currentUserInList && currentUser.id) {
				console.log('å½“å‰ç”¨æˆ·ä¸åœ¨æˆå‘˜åˆ—è¡¨ä¸­ï¼Œæ·»åŠ å½“å‰ç”¨æˆ·');
				allMembers.unshift({
					id: currentUser.id,
					name: currentUser.name || 'æˆ‘',
					avatar: currentUser.icon || '',
					role: 'å½“å‰ç”¨æˆ·',
					is_voice_enabled: true
				});
			} else if (currentUserInList && currentUser.icon) {
				// å¦‚æœå½“å‰ç”¨æˆ·åœ¨åˆ—è¡¨ä¸­ä½†æ²¡æœ‰å¤´åƒï¼Œæ›´æ–°å¤´åƒ
				if (!currentUserInList.avatar && currentUser.icon) {
					currentUserInList.avatar = currentUser.icon;
					console.log('æ›´æ–°å½“å‰ç”¨æˆ·åœ¨åˆ—è¡¨ä¸­çš„å¤´åƒ:', currentUser.icon);
				}
			}
			
			if (allMembers && Array.isArray(allMembers)) {
				allMembers.forEach((member, index) => {
					console.log(`æˆå‘˜ ${index + 1}:`, {
						id: member.id,
						name: member.name,
						avatar: member.avatar,
						æœ‰å¤´åƒ: !!member.avatar,
						æ˜¯å½“å‰ç”¨æˆ·: member.id === currentUser.id
					});
					
					const participant = document.createElement('div');
					participant.className = 'participant' + (index === 0 ? ' active' : '');
					participant.setAttribute('data-user-id', member.id || '');
					
					const avatar = document.createElement('div');
					avatar.className = 'participant-avatar';
					
					// å¦‚æœæˆå‘˜æœ‰å¤´åƒè·¯å¾„ï¼Œæ˜¾ç¤ºå¤´åƒå›¾ç‰‡
					if (member.avatar && member.avatar.trim() !== '') {
						console.log(`ä¸ºæˆå‘˜ ${member.name} è®¾ç½®å¤´åƒ:`, member.avatar);
						console.log('å¤´åƒè·¯å¾„ç±»å‹:', typeof member.avatar);
						console.log('å¤´åƒè·¯å¾„é•¿åº¦:', member.avatar.length);
						
						// å…ˆæ¸…ç©ºæ–‡å­—å†…å®¹å’ŒèƒŒæ™¯
						avatar.textContent = '';
						
						const img = document.createElement('img');
						// è®¾ç½®å›¾ç‰‡æº
						img.src = member.avatar;
						img.alt = member.name || member.id;
						
						// è®¾ç½®å›¾ç‰‡æ ·å¼
						img.style.display = 'block';
						img.style.width = '100%';
						img.style.height = '100%';
						img.style.objectFit = 'cover';
						img.style.borderRadius = '8px';
						img.style.position = 'absolute';
						img.style.top = '0';
						img.style.left = '0';
						
						// å¤´åƒåŠ è½½æˆåŠŸæ—¶ï¼Œç§»é™¤èƒŒæ™¯æ¸å˜
						img.onload = function() {
							console.log(`âœ… å¤´åƒåŠ è½½æˆåŠŸ: ${member.name}`);
							console.log('   - å¤´åƒè·¯å¾„:', member.avatar);
							console.log('   - å›¾ç‰‡å°ºå¯¸:', this.naturalWidth, 'x', this.naturalHeight);
							console.log('   - å›¾ç‰‡å®Œæ•´:', this.complete);
							avatar.style.background = 'transparent';  // ç§»é™¤èƒŒæ™¯æ¸å˜
							avatar.style.backgroundImage = 'none';  // ç¡®ä¿æ²¡æœ‰èƒŒæ™¯å›¾ç‰‡
						};
						
						// å¦‚æœå¤´åƒåŠ è½½å¤±è´¥ï¼Œæ˜¾ç¤ºåå­—é¦–å­—ç¬¦
						img.onerror = function() {
							console.error(`âŒ å¤´åƒåŠ è½½å¤±è´¥: ${member.name}`);
							console.error('   - å¤´åƒè·¯å¾„:', member.avatar);
							console.error('   - å®é™…src:', this.src);
							console.error('   - é”™è¯¯è¯¦æƒ…:', {
								src: this.src,
								naturalWidth: this.naturalWidth,
								naturalHeight: this.naturalHeight,
								complete: this.complete,
								é”™è¯¯: 'å¯èƒ½æ˜¯è·¯å¾„ä¸æ­£ç¡®æˆ–æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ–è€…æµè§ˆå™¨å®‰å…¨ç­–ç•¥é˜»æ­¢äº†file://åè®®'
							});
							this.style.display = 'none';
							avatar.textContent = member.name ? member.name.charAt(0) : '?';
							avatar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';  // æ¢å¤èƒŒæ™¯
							avatar.style.backgroundImage = 'none';
						};
						
						avatar.appendChild(img);
					} else {
						console.log(`æˆå‘˜ ${member.name} æ²¡æœ‰å¤´åƒè·¯å¾„ (avatar: ${member.avatar})`);
						// å¦‚æœæ²¡æœ‰å¤´åƒè·¯å¾„ï¼Œä½¿ç”¨åå­—çš„é¦–å­—ç¬¦ä½œä¸ºå¤´åƒ
						avatar.textContent = member.name ? member.name.charAt(0) : '?';
					}
					
					const name = document.createElement('div');
					name.className = 'participant-name';
					name.textContent = member.name || member.id;
					name.title = member.id + ' - ' + member.name;
					
					participant.appendChild(avatar);
					participant.appendChild(name);
					
					participant.addEventListener('click', () => {
						// ç§»é™¤æ‰€æœ‰activeç±»
						document.querySelectorAll('.participant').forEach(p => p.classList.remove('active'));
						// æ·»åŠ activeç±»åˆ°å½“å‰å‚ä¸è€…
						participant.classList.add('active');
					});
					
					list.appendChild(participant);
				});
				
				// å¦‚æœæœ‰è¯´è¯äººï¼Œæ›´æ–°é«˜äº®çŠ¶æ€
				updateSpeakingIndicator();
			} else {
				console.warn('æˆå‘˜æ•°æ®ä¸æ˜¯æ•°ç»„æˆ–ä¸ºç©º');
			}
		}
		
		// æ›´æ–°è¯´è¯äººæŒ‡ç¤ºå™¨
		function updateSpeakingIndicator() {
			// ç§»é™¤æ‰€æœ‰è¯´è¯çŠ¶æ€
			document.querySelectorAll('.participant').forEach(p => {
				p.classList.remove('speaking');
				// ç§»é™¤è¯´è¯æŒ‡ç¤ºå™¨
				const indicator = p.querySelector('.speaking-indicator');
				if (indicator) {
					indicator.remove();
				}
			});
			
			// å¦‚æœæœ‰è¯´è¯äººï¼Œé«˜äº®æ˜¾ç¤º
			if (currentSpeakingUserId) {
				const speakingParticipant = document.querySelector(`.participant[data-user-id="${currentSpeakingUserId}"]`);
				if (speakingParticipant) {
					speakingParticipant.classList.add('speaking');
					
					// æ·»åŠ è¯´è¯æŒ‡ç¤ºå™¨
					const indicator = document.createElement('div');
					indicator.className = 'speaking-indicator';
					speakingParticipant.appendChild(indicator);
					
					// åœ¨çŠ¶æ€æ—¥å¿—ä¸­æ˜¾ç¤º
					const member = membersData.find(m => m.id === currentSpeakingUserId);
					if (member) {
						appendStatusMessage(`ğŸ¤ ${member.name || member.id} æ­£åœ¨è¯´è¯`, 'info');
					}
				}
			}
		}
		
		// è¿æ¥WebSocket
		function connectWebSocket() {
			// è¯¦ç»†è°ƒè¯•ä¿¡æ¯
			console.log('=== connectWebSocket è¢«è°ƒç”¨ ===');
			console.log('currentUser:', currentUser);
			console.log('currentUser.id:', currentUser.id);
			console.log('currentUser.id ç±»å‹:', typeof currentUser.id);
			console.log('currentUser å®Œæ•´å¯¹è±¡:', JSON.stringify(currentUser));
			
			// WebSocket URLéœ€è¦åŒ…å«ç”¨æˆ·IDï¼Œæ ¼å¼: ws://47.100.126.194:5000/ws/{ç”¨æˆ·ID}
			const userId = (currentUser.id || '').toString().trim();
			console.log('å¤„ç†åçš„userId:', userId);
			console.log('userIdé•¿åº¦:', userId.length);
			
			if (!userId) {
				console.error('æ— æ³•è¿æ¥WebSocketï¼šç¼ºå°‘ç”¨æˆ·ID');
				console.error('currentUserå®Œæ•´å¯¹è±¡:', JSON.stringify(currentUser));
				console.error('appDataå®Œæ•´å¯¹è±¡:', JSON.stringify(appData));
				alert('é”™è¯¯ï¼šæ— æ³•è·å–ç”¨æˆ·IDï¼\nè¯·æ£€æŸ¥ç”¨æˆ·ä¿¡æ¯æ˜¯å¦æ­£ç¡®ä¼ é€’ã€‚\n\ncurrentUser: ' + JSON.stringify(currentUser));
				return;  // é‡è¦ï¼šå¦‚æœç”¨æˆ·IDä¸ºç©ºï¼Œä¸è¿æ¥WebSocket
			}
			
			// å†æ¬¡éªŒè¯userIdä¸ä¸ºç©º
			if (!userId || userId.length === 0) {
				console.error('ä¸¥é‡é”™è¯¯ï¼šuserIdä»ç„¶ä¸ºç©ºï¼Œä¸åº”è¯¥åˆ°è¾¾è¿™é‡Œï¼');
				return;
			}
			
			const wsUrl = 'ws://47.100.126.194:5000/ws/' + encodeURIComponent(userId);
			console.log('æ­£åœ¨è¿æ¥WebSocket:', wsUrl);
			console.log('ç”¨æˆ·ID:', userId);
			console.log('ç¼–ç åçš„ç”¨æˆ·ID:', encodeURIComponent(userId));
			console.log('å®Œæ•´WebSocket URL:', wsUrl);
			
			const statusInfo = document.getElementById('connectionStatus');
			if (statusInfo) {
				statusInfo.textContent = `å½“å‰ç”¨æˆ·ID: ${userId}ï¼ŒWebSocket: ${wsUrl}`;
			}
			
			// åˆ›å»ºWebSocketè¿æ¥
			console.log('å‡†å¤‡åˆ›å»ºWebSocketè¿æ¥...');
			ws = new WebSocket(wsUrl);
			console.log('WebSocketå¯¹è±¡å·²åˆ›å»ºï¼ŒçŠ¶æ€:', ws.readyState);
			
			ws.onopen = function() {
				console.log('========== WebSocketè¿æ¥æˆåŠŸ ==========');
				console.log('âœ… [WebSocket] è¿æ¥å·²å»ºç«‹');
				console.log('   - WebSocket URL:', wsUrl);
				console.log('   - è¿æ¥çŠ¶æ€:', ws.readyState);
				console.log('   - åè®®:', ws.protocol);
				
				// æ›´æ–°è¿æ¥çŠ¶æ€
				const statusInfo = document.getElementById('connectionStatus');
				if (statusInfo) {
					statusInfo.textContent = 'âœ… WebSocketå·²è¿æ¥ï¼Œæ­£åœ¨è·å–éº¦å…‹é£æƒé™...';
				}
				
				// å¦‚æœæˆ¿é—´IDå·²ä»C++ä¼ å…¥ï¼Œæ›´æ–°æˆ¿é—´ä¿¡æ¯ï¼›å¦åˆ™ç­‰å¾…æœåŠ¡å™¨è¿”å›room_createdæ¶ˆæ¯
				console.log('ğŸ” [WebSocket] æ£€æŸ¥æˆ¿é—´ä¿¡æ¯:');
				console.log('   - roomId:', roomId);
				console.log('   - whepUrl:', whepUrl);
				console.log('   - whipUrl:', whipUrl);
				console.log('   - streamName:', streamName);
				
				if (roomId) {
					console.log('âœ… [WebSocket] æˆ¿é—´IDå·²ä»C++ä¼ å…¥');
					console.log('   - æˆ¿é—´ID:', roomId);
					console.log('   - æ¨æµåœ°å€:', whipUrl);
					console.log('   - æ‹‰æµåœ°å€:', whepUrl);
					console.log('   - æµåç§°:', streamName);
					// æ›´æ–°æˆ¿é—´ä¿¡æ¯
					roomInfo = {
						room_id: roomId,
						whip_url: whipUrl,
						whep_url: whepUrl,
						stream_name: streamName,
						group_id: groupId
					};
					// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæˆ¿é—´ä¿¡æ¯
					appendStatusMessage(`âœ… æˆ¿é—´å·²åˆ›å»ºï¼ŒID: ${roomId}ã€‚`, 'success');
					
					// æˆ¿é—´åˆ›å»ºæˆåŠŸåï¼Œå¼€å§‹æ‹‰æµ
					if (whepUrl) {
						console.log('ğŸ§ [æ‹‰æµ] æˆ¿é—´å·²åˆ›å»ºï¼Œå¼€å§‹æ‹‰æµ...');
						startPullStream(whepUrl);
					} else {
						console.warn('âš ï¸ [æ‹‰æµ] æ‹‰æµåœ°å€ä¸ºç©ºï¼Œæ— æ³•å¼€å§‹æ‹‰æµ');
						appendStatusMessage('âš ï¸ æ‹‰æµåœ°å€ä¸ºç©ºï¼Œæ— æ³•å¼€å§‹æ‹‰æµ', 'warning');
					}
				} else {
					console.log('âš ï¸ [WebSocket] æˆ¿é—´IDæœªä¼ å…¥ï¼Œç­‰å¾…æœåŠ¡å™¨è¿”å›room_createdæ¶ˆæ¯');
				}
				
				// WebSocketè¿æ¥æˆåŠŸåï¼Œé¢„å…ˆè¯·æ±‚éº¦å…‹é£æƒé™ï¼ˆé¿å…æŒ‰ä½æŒ‰é’®æ—¶å¼¹å‡ºæƒé™å¯¹è¯æ¡†ï¼‰
				console.log('ğŸ¤ [WebSocket] å¼€å§‹é¢„å…ˆè·å–éº¦å…‹é£æƒé™...');
				requestMicrophonePermission().then(() => {
					const statusInfo = document.getElementById('connectionStatus');
					if (statusInfo) {
						statusInfo.textContent = 'âœ… WebSocketå·²è¿æ¥ï¼Œéº¦å…‹é£å·²å°±ç»ªï¼Œè¯·æŒ‰ä½"æŒ‰ä½å¼€å§‹å¯¹è®²"æŒ‰é’®å¼€å§‹æ¨æµ';
					}
					console.log('========== WebSocketåˆå§‹åŒ–å®Œæˆ ==========');
				}).catch(error => {
					console.error('âŒ [WebSocket] è·å–éº¦å…‹é£æƒé™å¤±è´¥:', error);
					console.log('========== WebSocketåˆå§‹åŒ–å®Œæˆï¼ˆæƒé™è·å–å¤±è´¥ï¼‰ ==========');
				});
			};
			
			ws.onmessage = function(event) {
				console.log('========================================');
				console.log('ğŸ“¥ æ”¶åˆ°WebSocketæ¶ˆæ¯:');
				console.log('åŸå§‹æ•°æ®:', event.data);
				console.log('æ•°æ®ç±»å‹:', typeof event.data);
				console.log('æ•°æ®é•¿åº¦:', event.data ? event.data.length : 0);
				
				try {
					const message = JSON.parse(event.data);
					console.log('è§£æåçš„æ¶ˆæ¯å¯¹è±¡:', message);
					console.log('æ¶ˆæ¯ç±»å‹:', message.type);
					console.log('å®Œæ•´æ¶ˆæ¯å†…å®¹:', JSON.stringify(message, null, 2));
					console.log('========================================');
					
					handleWebSocketMessage(message);
				} catch (e) {
					console.error('âŒ è§£æWebSocketæ¶ˆæ¯å¤±è´¥:');
					console.error('é”™è¯¯:', e);
					console.error('åŸå§‹æ•°æ®:', event.data);
					console.error('========================================');
				}
			};
			
			ws.onerror = function(error) {
				console.error('========== WebSocketé”™è¯¯ ==========');
				console.error('âŒ [WebSocketé”™è¯¯] é”™è¯¯è¯¦æƒ…:');
				console.error('   - é”™è¯¯å¯¹è±¡:', error);
				console.error('   - WebSocketçŠ¶æ€:', ws.readyState);
				// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ç»™ç”¨æˆ·
				appendStatusMessage('âš ï¸ WebSocketè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–è”ç³»ç®¡ç†å‘˜ã€‚', 'error');
				console.log('========== WebSocketé”™è¯¯å¤„ç†å®Œæˆ ==========');
			};
			
			ws.onclose = function(event) {
				console.log('========== WebSocketè¿æ¥å…³é—­ ==========');
				console.log('ğŸ”Œ [WebSocketå…³é—­] è¿æ¥å·²å…³é—­');
				console.log('   - å…³é—­ä»£ç :', event.code);
				console.log('   - å…³é—­åŸå› :', event.reason);
				console.log('   - æ˜¯å¦æ­£å¸¸å…³é—­:', event.wasClean);
				// å¦‚æœæ˜¯å› ä¸º403é”™è¯¯å…³é—­ï¼Œæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
				if (event.code === 1006 || event.code === 403) {
					console.error('âŒ [WebSocketå…³é—­] è¿æ¥è¢«æœåŠ¡å™¨æ‹’ç»ï¼Œå¯èƒ½æ˜¯è®¤è¯å¤±è´¥');
					appendStatusMessage('âŒ è¿æ¥è¢«æœåŠ¡å™¨æ‹’ç»ï¼Œå¯èƒ½æ˜¯è®¤è¯å¤±è´¥ã€‚', 'error');
				}
				console.log('========== WebSocketå…³é—­å¤„ç†å®Œæˆ ==========');
			};
		}
		
		// æ³¨æ„ï¼šcreateRoom() å‡½æ•°å·²ç§»é™¤ï¼Œæˆ¿é—´åˆ›å»ºç°åœ¨ç”±C++ç«¯çš„ScheduleDialogåœ¨åˆå§‹åŒ–æ—¶å®Œæˆ
		// å¦‚æœæˆ¿é—´IDå·²ä»C++ä¼ å…¥ï¼Œåˆ™ç›´æ¥ä½¿ç”¨ï¼›å¦åˆ™ç­‰å¾…æœåŠ¡å™¨è¿”å›room_createdæ¶ˆæ¯
		
		// è®¾ç½® ICE candidate å¤„ç†ï¼ˆä¼ ç»Ÿ API æ–¹å¼ï¼ŒICE candidate è‡ªåŠ¨å¤„ç†ï¼‰
		function setupIceCandidate(pc) {
			pc.onicecandidate = e => {
				if (e.candidate) {
					console.log("ğŸ“¡ ICE candidate:", e.candidate.candidate);
				} else {
					console.log("âœ… ICEå€™é€‰æ”¶é›†å®Œæˆ");
				}
			};
		}
		
		// å¼€å§‹æ‹‰æµï¼ˆå‚è€ƒæ¨æµçš„æ–¹å¼ï¼Œé€šè¿‡WebSocketå‘é€offerï¼‰
		async function startPullStream(whepUrl) {
			if (!whepUrl) {
				console.error('âŒ [æ‹‰æµ] æ‹‰æµåœ°å€ä¸ºç©º');
				appendStatusMessage('âŒ æ‹‰æµåœ°å€ä¸ºç©ºï¼Œæ— æ³•å¼€å§‹æ‹‰æµ', 'error');
				return;
			}
			
			if (!roomInfo) {
				console.error('âŒ [æ‹‰æµ] æˆ¿é—´ä¿¡æ¯ä¸ºç©º');
				appendStatusMessage('âŒ æˆ¿é—´ä¿¡æ¯ä¸ºç©ºï¼Œæ— æ³•å¼€å§‹æ‹‰æµ', 'error');
				return;
			}
			
			if (!ws || ws.readyState !== WebSocket.OPEN) {
				console.error('âŒ [æ‹‰æµ] WebSocketæœªè¿æ¥');
				appendStatusMessage('âŒ WebSocketæœªè¿æ¥ï¼Œæ— æ³•å¼€å§‹æ‹‰æµ', 'error');
				return;
			}
			
			if (subscribePc) {
				console.log('âš ï¸ [æ‹‰æµ] å·²ç»åœ¨æ‹‰æµä¸­ï¼Œå…ˆåœæ­¢ä¹‹å‰çš„æ‹‰æµ');
				stopPullStream();
			}
			
			console.log('========== å¼€å§‹æ‹‰æµ ==========');
			console.log('ğŸ§ [æ‹‰æµ] å¼€å§‹æ‹‰æµï¼Œæ‹‰æµåœ°å€:', whepUrl);
			appendStatusMessage('ğŸ§ æ­£åœ¨å¼€å§‹æ‹‰æµ...', 'info');
			
			try {
				// åˆ›å»ºæ‹‰æµçš„ PeerConnection
				subscribePc = new RTCPeerConnection({ iceServers });
				subscribeStream = null;
				
				// è®¾ç½®ICE candidateå¤„ç†
				setupIceCandidate(subscribePc);
				console.log('âœ… [æ‹‰æµ] ICE candidate å¤„ç†å·²è®¾ç½®');
				
				// ç›‘å¬è¿æ¥çŠ¶æ€å˜åŒ–
				subscribePc.onconnectionstatechange = () => {
					console.log('ğŸ“¡ [æ‹‰æµ] è¿æ¥çŠ¶æ€:', subscribePc.connectionState);
					if (subscribePc.connectionState === 'connected') {
						console.log('âœ… [æ‹‰æµ] æ‹‰æµè¿æ¥æˆåŠŸ');
						appendStatusMessage('âœ… æ‹‰æµè¿æ¥æˆåŠŸ', 'success');
					} else if (subscribePc.connectionState === 'failed' || subscribePc.connectionState === 'disconnected') {
						console.error('âŒ [æ‹‰æµ] æ‹‰æµè¿æ¥å¤±è´¥æˆ–æ–­å¼€');
						appendStatusMessage(`âŒ æ‹‰æµè¿æ¥${subscribePc.connectionState}`, 'error');
					}
				};
				
				// ç›‘å¬æ¥æ”¶åˆ°çš„åª’ä½“æµ
				subscribePc.ontrack = (event) => {
					console.log('ğŸ§ [æ‹‰æµ] æ”¶åˆ°éŸ³é¢‘æµ');
					subscribeStream = event.streams[0];
					
					// åˆ›å»ºéŸ³é¢‘å…ƒç´ å¹¶æ’­æ”¾
					const audioElement = document.createElement('audio');
					audioElement.srcObject = subscribeStream;
					audioElement.autoplay = true;
					audioElement.controls = false;
					audioElement.style.display = 'none';
					document.body.appendChild(audioElement);
					
					console.log('âœ… [æ‹‰æµ] éŸ³é¢‘æµå·²å¼€å§‹æ’­æ”¾');
					appendStatusMessage('âœ… éŸ³é¢‘æµå·²å¼€å§‹æ’­æ”¾', 'success');
				};
				
				// åˆ›å»º offerï¼ˆå‚è€ƒæ¨æµçš„æ–¹å¼ï¼‰
				console.log('ğŸ“¤ [æ‹‰æµ] æ­£åœ¨åˆ›å»º SDP offer...');
				const offer = await subscribePc.createOffer({
					offerToReceiveAudio: true,
					offerToReceiveVideo: false
				});
				console.log('âœ… [æ‹‰æµ] SDP offer åˆ›å»ºæˆåŠŸ');
				console.log('   - Offerç±»å‹:', offer.type);
				console.log('   - SDPé•¿åº¦:', offer.sdp ? offer.sdp.length : 0);
				
				await subscribePc.setLocalDescription(offer);
				console.log('âœ… [æ‹‰æµ] æœ¬åœ°æè¿°å·²è®¾ç½®');
				console.log('   - LocalDescriptionç±»å‹:', subscribePc.localDescription.type);
				console.log('   - ConnectionState:', subscribePc.connectionState);
				
				// æ„å»ºæµåç§°ï¼ˆä¼˜å…ˆä½¿ç”¨ stream_nameï¼Œå¦åˆ™ä½¿ç”¨ room_idï¼‰
				const streamName = roomInfo.stream_name || roomInfo.room_id;
				console.log('ğŸ“¤ [æ‹‰æµ] å‡†å¤‡å‘é€æ‹‰æµè¯·æ±‚åˆ°æœåŠ¡å™¨...');
				console.log('   - æµåç§°:', streamName);
				console.log('   - æˆ¿é—´ID:', roomInfo.room_id);
				console.log('   - ç¾¤ç»„ID:', roomInfo.group_id);
				
				// é€šè¿‡ WebSocket å‘é€ offer åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è½¬å‘ç»™ SRSï¼ˆå‚è€ƒæ¨æµçš„æ–¹å¼ï¼‰
				const message = {
					type: "srs_play_offer",
					sdp: subscribePc.localDescription.sdp,
					stream_name: streamName,
					room_id: roomInfo.room_id,
					group_id: roomInfo.group_id
				};
				
				ws.send(JSON.stringify(message));
				console.log('âœ… [æ‹‰æµ] æ‹‰æµ offer å·²å‘é€åˆ°æœåŠ¡å™¨');
				console.log('   - æ¶ˆæ¯ç±»å‹:', message.type);
				console.log('   - æµåç§°:', message.stream_name);
				console.log('   - æˆ¿é—´ID:', message.room_id);
				console.log('   - ç¾¤ç»„ID:', message.group_id);
				console.log('   - SDPé•¿åº¦:', message.sdp ? message.sdp.length : 0);
				
				// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå‘é€ä¿¡æ¯
				appendStatusMessage(`ğŸ“¤ æ­£åœ¨å‘é€æ‹‰æµè¯·æ±‚... Stream: ${streamName}`, 'info');
				console.log('========== æ‹‰æµè¯·æ±‚å·²å‘é€ï¼Œç­‰å¾…æœåŠ¡å™¨å“åº” ==========');
				
			} catch (error) {
				console.error('========== æ‹‰æµå¤±è´¥ ==========');
				console.error('âŒ [æ‹‰æµå¤±è´¥] é”™è¯¯è¯¦æƒ…:');
				console.error('   - é”™è¯¯ç±»å‹:', error.name);
				console.error('   - é”™è¯¯æ¶ˆæ¯:', error.message);
				console.error('   - é”™è¯¯å †æ ˆ:', error.stack);
				console.error('   - å®Œæ•´é”™è¯¯:', error);
				
				appendStatusMessage(`âŒ æ‹‰æµå¤±è´¥: ${error.message}`, 'error');
				console.log('========== æ‹‰æµå¤±è´¥å¤„ç†å®Œæˆ ==========');
				
				// æ¸…ç†èµ„æº
				if (subscribePc) {
					subscribePc.close();
					subscribePc = null;
				}
			}
		}
		
		// åœæ­¢æ‹‰æµ
		function stopPullStream() {
			if (!subscribePc) {
				return;
			}
			
			console.log('ğŸ›‘ [æ‹‰æµ] åœæ­¢æ‹‰æµ');
			appendStatusMessage('ğŸ›‘ æ­£åœ¨åœæ­¢æ‹‰æµ...', 'info');
			
			// åœæ­¢åª’ä½“æµ
			if (subscribeStream) {
				subscribeStream.getTracks().forEach(track => track.stop());
				subscribeStream = null;
			}
			
			// å…³é—­ PeerConnection
			subscribePc.close();
			subscribePc = null;
			
			// ç§»é™¤éŸ³é¢‘å…ƒç´ 
			const audioElements = document.querySelectorAll('audio[srcObject]');
			audioElements.forEach(audio => {
				if (audio.srcObject === subscribeStream) {
					audio.pause();
					audio.srcObject = null;
					audio.remove();
				}
			});
			
			console.log('âœ… [æ‹‰æµ] æ‹‰æµå·²åœæ­¢');
			appendStatusMessage('âœ… æ‹‰æµå·²åœæ­¢', 'info');
		}
		
		// é¢„å…ˆè·å–éº¦å…‹é£æƒé™ï¼ˆåœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨ï¼Œé¿å…æŒ‰ä½æŒ‰é’®æ—¶å¼¹å‡ºæƒé™å¯¹è¯æ¡†ï¼‰
		async function requestMicrophonePermission() {
			console.log('========== å¼€å§‹è·å–éº¦å…‹é£æƒé™ ==========');
			try {
				// å¦‚æœå·²æœ‰åª’ä½“æµä¸”æµä»ç„¶æ´»è·ƒï¼Œä¸éœ€è¦é‡æ–°è·å–
				if (publishStream && publishStream.getTracks().length > 0 && 
				    publishStream.getTracks().some(track => track.readyState === 'live')) {
					console.log('âœ… [éº¦å…‹é£æƒé™] å·²æœ‰æ´»è·ƒçš„éº¦å…‹é£éŸ³é¢‘æµï¼Œæ— éœ€é‡æ–°è·å–');
					console.log('   - åª’ä½“æµID:', publishStream.id);
					console.log('   - éŸ³è½¨æ•°é‡:', publishStream.getTracks().length);
					console.log('   - éŸ³è½¨çŠ¶æ€:', publishStream.getTracks().map(t => t.readyState));
					return;
				}
				
				console.log('ğŸ¤ [éº¦å…‹é£æƒé™] æ­£åœ¨è¯·æ±‚éº¦å…‹é£æƒé™...');
				// è·å–æœ¬åœ°åª’ä½“æµï¼ˆä½†ä¸ç«‹å³ä½¿ç”¨ï¼Œåªæ˜¯è·å–æƒé™ï¼‰
				publishStream = await navigator.mediaDevices.getUserMedia({
					audio: true,
					video: false
				});
				console.log("âœ… [éº¦å…‹é£æƒé™] è·å–æˆåŠŸï¼");
				console.log('   - åª’ä½“æµID:', publishStream.id);
				console.log('   - éŸ³è½¨æ•°é‡:', publishStream.getTracks().length);
				console.log('   - éŸ³è½¨ä¿¡æ¯:', publishStream.getTracks().map(t => ({
					id: t.id,
					kind: t.kind,
					enabled: t.enabled,
					readyState: t.readyState,
					label: t.label
				})));
				appendStatusMessage('âœ… éº¦å…‹é£æƒé™å·²è·å–ï¼Œå¯ä»¥å¼€å§‹å¯¹è®²', 'success');
				console.log('========== éº¦å…‹é£æƒé™è·å–å®Œæˆ ==========');
			} catch (error) {
				console.error('âŒ [éº¦å…‹é£æƒé™] è·å–å¤±è´¥ï¼');
				console.error('   - é”™è¯¯ç±»å‹:', error.name);
				console.error('   - é”™è¯¯æ¶ˆæ¯:', error.message);
				console.error('   - å®Œæ•´é”™è¯¯:', error);
				appendStatusMessage(`âš ï¸ è·å–éº¦å…‹é£æƒé™å¤±è´¥: ${error.message}ï¼Œè¯·åœ¨æŒ‰ä½æŒ‰é’®æ—¶å…è®¸ä½¿ç”¨éº¦å…‹é£`, 'warn');
				console.log('========== éº¦å…‹é£æƒé™è·å–å¤±è´¥ ==========');
				// ä¸é˜»æ­¢åç»­æ“ä½œï¼Œç”¨æˆ·å¯ä»¥åœ¨æŒ‰ä½æŒ‰é’®æ—¶å†æ¬¡æˆæƒ
			}
		}
		
		// å¼€å§‹æ¨æµï¼ˆé€šè¿‡æœåŠ¡å™¨è½¬å‘åˆ° SRSï¼Œä¼ ç»Ÿ API æ–¹å¼ï¼‰
		async function startPublishing() {
			console.log('========== å¼€å§‹æ¨æµæµç¨‹ ==========');
			console.log('ğŸ“¤ [æ¨æµ] å¼€å§‹æ¨æµï¼ˆä¼ ç»Ÿ API æ–¹å¼ï¼‰...');
			console.log('   - å½“å‰æ¨æµçŠ¶æ€:', isPublishing);
			console.log('   - æˆ¿é—´ä¿¡æ¯:', roomInfo);
			console.log('   - WebSocketçŠ¶æ€:', ws ? ws.readyState : 'null');
			
			if (!roomInfo || !roomInfo.room_id) {
				console.error('âŒ [æ¨æµå¤±è´¥] æˆ¿é—´ä¿¡æ¯ä¸ºç©º');
				console.error('   - roomInfo:', roomInfo);
				console.error('   - roomId:', roomId);
				appendStatusMessage('âŒ æ— æ³•æ¨é€éŸ³é¢‘ï¼šæˆ¿é—´ä¿¡æ¯ä¸ºç©ºï¼Œè¯·ç­‰å¾…æˆ¿é—´åˆ›å»ºã€‚', 'error');
				// æ¢å¤æŒ‰é’®çŠ¶æ€
				if (isPublishing) {
					const voiceBtn = document.querySelector('.voice-btn');
					if (voiceBtn) {
						voiceBtn.classList.remove('active');
					}
					isPublishing = false;
				}
				console.log('========== æ¨æµå¤±è´¥ï¼šæˆ¿é—´ä¿¡æ¯ä¸ºç©º ==========');
				return;
			}

			if (!ws || ws.readyState !== WebSocket.OPEN) {
				console.error('âŒ [æ¨æµå¤±è´¥] WebSocketæœªè¿æ¥');
				console.error('   - wså¯¹è±¡:', ws);
				console.error('   - WebSocketçŠ¶æ€:', ws ? ws.readyState : 'null');
				console.error('   - OPENçŠ¶æ€å€¼:', WebSocket.OPEN);
				appendStatusMessage('âŒ æ— æ³•æ¨é€éŸ³é¢‘ï¼šWebSocketæœªè¿æ¥ï¼Œè¯·ç¨å€™ã€‚', 'error');
				// æ¢å¤æŒ‰é’®çŠ¶æ€
				if (isPublishing) {
					const voiceBtn = document.querySelector('.voice-btn');
					if (voiceBtn) {
						voiceBtn.classList.remove('active');
					}
					isPublishing = false;
				}
				console.log('========== æ¨æµå¤±è´¥ï¼šWebSocketæœªè¿æ¥ ==========');
				return;
			}

			try {
				console.log('ğŸ“¤ [æ¨æµ] å¼€å§‹åˆ›å»º RTCPeerConnection...');

				// å¦‚æœå·²æœ‰ RTCPeerConnectionï¼Œå…ˆå…³é—­
				if (publishPc) {
					console.log('âš ï¸ [æ¨æµ] æ£€æµ‹åˆ°æ—§çš„ RTCPeerConnectionï¼Œæ­£åœ¨å…³é—­...');
					publishPc.close();
					publishPc = null;
				}

				// åˆ›å»º RTCPeerConnection
				publishPc = new RTCPeerConnection({
					iceServers: iceServers
				});
				console.log('âœ… [æ¨æµ] RTCPeerConnection åˆ›å»ºæˆåŠŸ');
				console.log('   - ConnectionState:', publishPc.connectionState);
				console.log('   - IceConnectionState:', publishPc.iceConnectionState);

				// è®¾ç½® ICE candidate å¤„ç†
				setupIceCandidate(publishPc);
				console.log('âœ… [æ¨æµ] ICE candidate å¤„ç†å·²è®¾ç½®');

				// å¦‚æœå·²æœ‰åª’ä½“æµä¸”æµä»ç„¶æ´»è·ƒï¼Œå¤ç”¨ï¼›å¦åˆ™é‡æ–°è·å–
				if (!publishStream || publishStream.getTracks().length === 0 || 
				    publishStream.getTracks().every(track => track.readyState === 'ended')) {
					console.log('ğŸ¤ [æ¨æµ] éœ€è¦è·å–æ–°çš„éº¦å…‹é£éŸ³é¢‘æµ...');
					// å¦‚æœæ—§çš„æµå­˜åœ¨ä½†å·²ç»“æŸï¼Œå…ˆåœæ­¢
					if (publishStream) {
						console.log('   - åœæ­¢æ—§çš„åª’ä½“æµ');
						publishStream.getTracks().forEach(t => t.stop());
						publishStream = null;
					}
					
					// è·å–æœ¬åœ°åª’ä½“æµ
					console.log('   - æ­£åœ¨è¯·æ±‚ getUserMedia...');
					publishStream = await navigator.mediaDevices.getUserMedia({
						audio: true,
						video: false
					});
					console.log("âœ… [æ¨æµ] å·²è·å–æ–°çš„éº¦å…‹é£éŸ³é¢‘æµ");
					console.log('   - åª’ä½“æµID:', publishStream.id);
					console.log('   - éŸ³è½¨æ•°é‡:', publishStream.getTracks().length);
				} else {
					console.log("âœ… [æ¨æµ] å¤ç”¨å·²æœ‰çš„éº¦å…‹é£éŸ³é¢‘æµ");
					console.log('   - åª’ä½“æµID:', publishStream.id);
					console.log('   - éŸ³è½¨æ•°é‡:', publishStream.getTracks().length);
					console.log('   - éŸ³è½¨çŠ¶æ€:', publishStream.getTracks().map(t => t.readyState));
				}

				// æ·»åŠ åª’ä½“æµåˆ° PeerConnection
				let tracksAdded = 0;
				publishStream.getTracks().forEach(track => {
					if (track.readyState === 'live') {
						publishPc.addTrack(track, publishStream);
						tracksAdded++;
						console.log(`âœ… [æ¨æµ] å·²æ·»åŠ éŸ³è½¨åˆ° PeerConnection: ${track.id} (${track.kind})`);
					} else {
						console.warn(`âš ï¸ [æ¨æµ] è·³è¿‡éæ´»è·ƒéŸ³è½¨: ${track.id} (çŠ¶æ€: ${track.readyState})`);
					}
				});
				console.log(`âœ… [æ¨æµ] å…±æ·»åŠ  ${tracksAdded} ä¸ªéŸ³è½¨åˆ° PeerConnection`);

				// åˆ›å»º offer
				console.log('ğŸ“¤ [æ¨æµ] æ­£åœ¨åˆ›å»º SDP offer...');
				const offer = await publishPc.createOffer();
				console.log('âœ… [æ¨æµ] SDP offer åˆ›å»ºæˆåŠŸ');
				console.log('   - Offerç±»å‹:', offer.type);
				console.log('   - SDPé•¿åº¦:', offer.sdp ? offer.sdp.length : 0);
				
				await publishPc.setLocalDescription(offer);
				console.log('âœ… [æ¨æµ] æœ¬åœ°æè¿°å·²è®¾ç½®');
				console.log('   - LocalDescriptionç±»å‹:', publishPc.localDescription.type);
				console.log('   - ConnectionState:', publishPc.connectionState);

				// æ„å»ºæµåç§°ï¼ˆä¼˜å…ˆä½¿ç”¨ stream_nameï¼Œå¦åˆ™ä½¿ç”¨ room_idï¼‰
				const streamName = roomInfo.stream_name || roomInfo.room_id;
				console.log('ğŸ“¤ [æ¨æµ] å‡†å¤‡å‘é€æ¨æµè¯·æ±‚åˆ°æœåŠ¡å™¨...');
				console.log('   - æµåç§°:', streamName);
				console.log('   - æˆ¿é—´ID:', roomInfo.room_id);
				console.log('   - ç¾¤ç»„ID:', roomInfo.group_id);

				// é€šè¿‡ WebSocket å‘é€ offer åˆ°æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨è½¬å‘ç»™ SRS
				const message = {
					type: "srs_publish_offer",
					sdp: publishPc.localDescription.sdp,
					stream_name: streamName,
					room_id: roomInfo.room_id,
					group_id: roomInfo.group_id
				};

				ws.send(JSON.stringify(message));
				console.log('âœ… [æ¨æµ] æ¨æµ offer å·²å‘é€åˆ°æœåŠ¡å™¨');
				console.log('   - æ¶ˆæ¯ç±»å‹:', message.type);
				console.log('   - æµåç§°:', message.stream_name);
				console.log('   - æˆ¿é—´ID:', message.room_id);
				console.log('   - ç¾¤ç»„ID:', message.group_id);
				console.log('   - SDPé•¿åº¦:', message.sdp ? message.sdp.length : 0);
				
				// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºå‘é€ä¿¡æ¯
				appendStatusMessage(`ğŸ“¤ æ­£åœ¨å‘é€æ¨æµè¯·æ±‚... Stream: ${streamName}`, 'info');
				console.log('========== æ¨æµè¯·æ±‚å·²å‘é€ï¼Œç­‰å¾…æœåŠ¡å™¨å“åº” ==========');

			} catch (error) {
				console.error('========== æ¨æµå¤±è´¥ ==========');
				console.error('âŒ [æ¨æµå¤±è´¥] é”™è¯¯è¯¦æƒ…:');
				console.error('   - é”™è¯¯ç±»å‹:', error.name);
				console.error('   - é”™è¯¯æ¶ˆæ¯:', error.message);
				console.error('   - é”™è¯¯å †æ ˆ:', error.stack);
				console.error('   - å®Œæ•´é”™è¯¯å¯¹è±¡:', error);
				
				// æ¸…ç†èµ„æº
				if (publishPc) {
					console.log('   - æ­£åœ¨æ¸…ç† RTCPeerConnection...');
					publishPc.close();
					publishPc = null;
				}
				
				// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
				appendStatusMessage(`âŒ æ¨æµå¤±è´¥: ${error.message}`, 'error');
				
				// æ¢å¤æŒ‰é’®çŠ¶æ€
				if (isPublishing) {
					const voiceBtn = document.querySelector('.voice-btn');
					if (voiceBtn) {
						voiceBtn.classList.remove('active');
					}
					isPublishing = false;
				}
				console.log('========== æ¨æµå¤±è´¥å¤„ç†å®Œæˆ ==========');
			}
		}
		
		// åœæ­¢æ¨æµ
		function stopPublishing() {
			console.log('========== å¼€å§‹åœæ­¢æ¨æµ ==========');
			console.log('ğŸ›‘ [åœæ­¢æ¨æµ] å¼€å§‹åœæ­¢æ¨æµ...');
			console.log('   - å½“å‰æ¨æµçŠ¶æ€:', isPublishing);
			console.log('   - RTCPeerConnectionçŠ¶æ€:', publishPc ? publishPc.connectionState : 'null');
			console.log('   - åª’ä½“æµçŠ¶æ€:', publishStream ? 'å­˜åœ¨' : 'null');
			
			try {
				// åªå…³é—­ RTCPeerConnectionï¼Œä¿ç•™åª’ä½“æµä»¥ä¾¿ä¸‹æ¬¡å¤ç”¨ï¼ˆé¿å…é‡å¤è¯·æ±‚æƒé™ï¼‰
				if (publishPc) {
					console.log('ğŸ›‘ [åœæ­¢æ¨æµ] æ­£åœ¨å…³é—­ RTCPeerConnection...');
					console.log('   - å…³é—­å‰çŠ¶æ€:', publishPc.connectionState);
					console.log('   - å…³é—­å‰ICEçŠ¶æ€:', publishPc.iceConnectionState);
					
					publishPc.close();
					publishPc = null;
					console.log('âœ… [åœæ­¢æ¨æµ] RTCPeerConnection å·²å…³é—­');
				} else {
					console.log('âš ï¸ [åœæ­¢æ¨æµ] RTCPeerConnection ä¸å­˜åœ¨ï¼Œæ— éœ€å…³é—­');
				}
				
				// æ³¨æ„ï¼šä¸åœæ­¢ publishStreamï¼Œä»¥ä¾¿ä¸‹æ¬¡å¤ç”¨ï¼Œé¿å…é‡å¤è¯·æ±‚æƒé™
				// åªæœ‰åœ¨é¡µé¢å…³é—­æ—¶æ‰åœæ­¢åª’ä½“æµ
				if (publishStream) {
					console.log('âœ… [åœæ­¢æ¨æµ] åª’ä½“æµå·²ä¿ç•™ä»¥ä¾¿ä¸‹æ¬¡å¤ç”¨');
					console.log('   - åª’ä½“æµID:', publishStream.id);
					console.log('   - éŸ³è½¨æ•°é‡:', publishStream.getTracks().length);
					console.log('   - éŸ³è½¨çŠ¶æ€:', publishStream.getTracks().map(t => t.readyState));
				} else {
					console.log('âš ï¸ [åœæ­¢æ¨æµ] åª’ä½“æµä¸å­˜åœ¨');
				}
				
				console.log('âœ… [åœæ­¢æ¨æµ] åœæ­¢æ¨æµæˆåŠŸ');
				console.log('========== åœæ­¢æ¨æµå®Œæˆ ==========');
			} catch (error) {
				console.error('âŒ [åœæ­¢æ¨æµå¤±è´¥] é”™è¯¯è¯¦æƒ…:');
				console.error('   - é”™è¯¯ç±»å‹:', error.name);
				console.error('   - é”™è¯¯æ¶ˆæ¯:', error.message);
				console.error('   - å®Œæ•´é”™è¯¯:', error);
				console.log('========== åœæ­¢æ¨æµå¤±è´¥ ==========');
			}
		}
		
		// å¤„ç†WebSocketæ¶ˆæ¯
		function handleWebSocketMessage(message) {
			console.log('========================================');
			console.log('ğŸ”” å¤„ç†WebSocketæ¶ˆæ¯:');
			console.log('æ¶ˆæ¯å¯¹è±¡:', message);
			console.log('æ¶ˆæ¯ç±»å‹:', message.type);
			console.log('æ¶ˆæ¯å®Œæ•´å†…å®¹:', JSON.stringify(message, null, 2));
			
			// æ ¹æ®æ¶ˆæ¯ç±»å‹è¿›è¡Œå¤„ç†
			if (message.type !== undefined) {
				console.log('æ¶ˆæ¯æœ‰typeå­—æ®µï¼Œå€¼ä¸º:', message.type);
				switch(String(message.type)) {
					case "room_created":
					case "6":
						console.log('âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸï¼');
						console.log('æˆ¿é—´ID:', message.room_id);
						if (message.room_id) {
							roomId = message.room_id;
							// æ›´æ–°æˆ¿é—´ä¿¡æ¯
							roomInfo = {
								room_id: message.room_id,
								whip_url: message.whip_url,
								whep_url: message.whep_url,
								stream_name: message.stream_name || message.room_id,
								group_id: message.group_id || groupId
							};
							console.log('å·²æ›´æ–°æˆ¿é—´ä¿¡æ¯:', roomInfo);
							
							// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
							appendStatusMessage(`âœ… æˆ¿é—´åˆ›å»ºæˆåŠŸï¼ŒID: ${message.room_id}`, 'success');
							
							// æˆ¿é—´åˆ›å»ºæˆåŠŸåï¼Œå¼€å§‹æ‹‰æµ
							if (message.whep_url) {
								console.log('ğŸ§ [æ‹‰æµ] æˆ¿é—´åˆ›å»ºæˆåŠŸï¼Œå¼€å§‹æ‹‰æµ...');
								startPullStream(message.whep_url);
							}
							
							// æˆ¿é—´åˆ›å»ºæˆåŠŸåï¼Œä¸å†è‡ªåŠ¨å¼€å§‹æ¨æµï¼Œç­‰å¾…ç”¨æˆ·æŒ‰ä¸‹æŒ‰é’®
							console.log('ğŸ¤ æˆ¿é—´åˆ›å»ºæˆåŠŸï¼Œç­‰å¾…ç”¨æˆ·æŒ‰ä¸‹"æŒ‰ä½å¼€å§‹å¯¹è®²"æŒ‰é’®...');
						}
						break;
					case "srs_answer":
						// æ”¶åˆ°æœåŠ¡å™¨è½¬å‘çš„ SRS answerï¼ˆå¯èƒ½æ˜¯æ¨æµæˆ–æ‹‰æµï¼‰
						console.log('========== æ”¶åˆ° SRS Answer ==========');
						console.log('ğŸ“¥ [SRS Answer] æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ SRS answer');
						console.log('   - action:', message.action);
						console.log('   - æ˜¯å¦æœ‰SDP:', !!message.sdp);
						console.log('   - publishPcçŠ¶æ€:', publishPc ? publishPc.connectionState : 'null');
						console.log('   - subscribePcçŠ¶æ€:', subscribePc ? subscribePc.connectionState : 'null');
						
						// å¤„ç†æ¨æµ answer
						if (message.action === 'publish' && message.sdp && publishPc) {
							console.log('ğŸ“¥ [æ¨æµAnswer] æ­£åœ¨è®¾ç½®è¿œç¨‹æè¿°...');
							publishPc.setRemoteDescription({
								type: 'answer',
								sdp: message.sdp
							}).then(() => {
								console.log('========== æ¨æµæˆåŠŸ ==========');
								console.log('âœ… [æ¨æµæˆåŠŸ] æ¨æµè¿æ¥å»ºç«‹æˆåŠŸï¼');
								console.log('   - ConnectionState:', publishPc.connectionState);
								console.log('   - IceConnectionState:', publishPc.iceConnectionState);
								console.log('   - è¿œç¨‹æè¿°ç±»å‹:', publishPc.remoteDescription ? publishPc.remoteDescription.type : 'null');
								console.log('   - æœ¬åœ°æè¿°ç±»å‹:', publishPc.localDescription ? publishPc.localDescription.type : 'null');
								
								// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
								appendStatusMessage('âœ… æ¨æµè¿æ¥å»ºç«‹æˆåŠŸï¼', 'success');
								console.log('========== æ¨æµæˆåŠŸå¤„ç†å®Œæˆ ==========');
							}).catch(error => {
								console.error('========== æ¨æµå¤±è´¥ï¼šè®¾ç½®Answerå¤±è´¥ ==========');
								console.error('âŒ [æ¨æµå¤±è´¥] è®¾ç½® answer å¤±è´¥:');
								console.error('   - é”™è¯¯ç±»å‹:', error.name);
								console.error('   - é”™è¯¯æ¶ˆæ¯:', error.message);
								console.error('   - é”™è¯¯å †æ ˆ:', error.stack);
								console.error('   - å®Œæ•´é”™è¯¯:', error);
								
								// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
								appendStatusMessage(`âŒ è®¾ç½® answer å¤±è´¥: ${error.message}`, 'error');
								console.log('========== æ¨æµå¤±è´¥å¤„ç†å®Œæˆ ==========');
							});
						}
						// å¤„ç†æ‹‰æµ answer
						else if (message.action === 'play' && message.sdp && subscribePc) {
							console.log('ğŸ“¥ [æ‹‰æµAnswer] æ­£åœ¨è®¾ç½®è¿œç¨‹æè¿°...');
							subscribePc.setRemoteDescription({
								type: 'answer',
								sdp: message.sdp
							}).then(() => {
								console.log('========== æ‹‰æµæˆåŠŸ ==========');
								console.log('âœ… [æ‹‰æµæˆåŠŸ] æ‹‰æµè¿æ¥å»ºç«‹æˆåŠŸï¼');
								console.log('   - ConnectionState:', subscribePc.connectionState);
								console.log('   - IceConnectionState:', subscribePc.iceConnectionState);
								console.log('   - è¿œç¨‹æè¿°ç±»å‹:', subscribePc.remoteDescription ? subscribePc.remoteDescription.type : 'null');
								console.log('   - æœ¬åœ°æè¿°ç±»å‹:', subscribePc.localDescription ? subscribePc.localDescription.type : 'null');
								
								// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºæˆåŠŸä¿¡æ¯
								appendStatusMessage('âœ… æ‹‰æµè¿æ¥å»ºç«‹æˆåŠŸï¼', 'success');
								console.log('========== æ‹‰æµæˆåŠŸå¤„ç†å®Œæˆ ==========');
							}).catch(error => {
								console.error('========== æ‹‰æµå¤±è´¥ï¼šè®¾ç½®Answerå¤±è´¥ ==========');
								console.error('âŒ [æ‹‰æµå¤±è´¥] è®¾ç½® answer å¤±è´¥:');
								console.error('   - é”™è¯¯ç±»å‹:', error.name);
								console.error('   - é”™è¯¯æ¶ˆæ¯:', error.message);
								console.error('   - é”™è¯¯å †æ ˆ:', error.stack);
								console.error('   - å®Œæ•´é”™è¯¯:', error);
								
								// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
								appendStatusMessage(`âŒ è®¾ç½®æ‹‰æµ answer å¤±è´¥: ${error.message}`, 'error');
								console.log('========== æ‹‰æµå¤±è´¥å¤„ç†å®Œæˆ ==========');
							});
						} else {
							console.warn('âš ï¸ [SRS Answer] æ¶ˆæ¯æ ¼å¼ä¸æ­£ç¡®æˆ–å¯¹åº”çš„ PeerConnection ä¸å­˜åœ¨');
							console.warn('   - action:', message.action);
							console.warn('   - æ˜¯å¦æœ‰SDP:', !!message.sdp);
							console.warn('   - publishPc:', publishPc);
							console.warn('   - subscribePc:', subscribePc);
						}
						break;
					case "srs_error":
						// æ”¶åˆ°æœåŠ¡å™¨è¿”å›çš„ SRS é”™è¯¯
						console.error('âŒ SRS é”™è¯¯:', message.message);
						
						// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
						appendStatusMessage(`âŒ SRS é”™è¯¯: ${message.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
						break;
					case "room_error":
					case "error":
						console.error('âŒ æˆ¿é—´åˆ›å»ºå¤±è´¥:');
						console.error('é”™è¯¯ä¿¡æ¯:', message.error || message.message);
						
						// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
						appendStatusMessage(`âŒ æˆ¿é—´åˆ›å»ºå¤±è´¥: ${message.error || message.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
						break;
					case "temp_room_closed":
						// æ”¶åˆ°æˆ¿é—´è§£æ•£é€šçŸ¥
						console.log('âš ï¸ æˆ¿é—´å·²è§£æ•£:', message.message);
						
						// åœæ­¢æ¨æµ
						stopPublishing();
						
						// æ¸…ç†æˆ¿é—´ä¿¡æ¯
						roomInfo = null;
						
						// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé€šçŸ¥
						appendStatusMessage(`âš ï¸ ${message.message || 'æˆ¿é—´å·²è§£æ•£'}`, 'warn');
						break;
					case "voice_speaking":
						// å¤„ç†è¯´è¯äººè¯†åˆ«æ¶ˆæ¯
						console.log('ğŸ¤ æ”¶åˆ°è¯´è¯äººè¯†åˆ«æ¶ˆæ¯:', message);
						const userId = message.user_id || '';
						const userName = message.user_name || '';
						const isSpeaking = message.is_speaking || false;
						
						if (isSpeaking) {
							// å¼€å§‹è¯´è¯
							currentSpeakingUserId = userId;
							console.log('ğŸ¤ æ£€æµ‹åˆ°è¯´è¯äºº:', userName, '(', userId, ')');
							updateSpeakingIndicator();
						} else {
							// åœæ­¢è¯´è¯
							if (currentSpeakingUserId === userId) {
								console.log('ğŸ›‘ è¯´è¯äººåœæ­¢è¯´è¯:', userName);
								currentSpeakingUserId = null;
								updateSpeakingIndicator();
							}
						}
						break;
					default:
						console.log('ğŸ“¨ æ”¶åˆ°å…¶ä»–ç±»å‹æ¶ˆæ¯:');
						console.log('ç±»å‹å€¼:', message.type);
						console.log('å®Œæ•´æ¶ˆæ¯:', message);
						
						// è¿‡æ»¤æ‰ä¸éœ€è¦æ˜¾ç¤ºçš„æ¶ˆæ¯ç±»å‹
						const ignoredMessageTypes = [
							'unread_notifications',  // æœªè¯»é€šçŸ¥
							'prepare_class_history', // è¯¾å‰å‡†å¤‡å†å²
							// å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å…¶ä»–ä¸éœ€è¦æ˜¾ç¤ºçš„æ¶ˆæ¯ç±»å‹
						];
						
						if (!ignoredMessageTypes.includes(message.type)) {
							// åªæ˜¾ç¤ºä¸åœ¨è¿‡æ»¤åˆ—è¡¨ä¸­çš„æ¶ˆæ¯
							appendStatusMessage(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(message)}`, 'info');
						} else {
							console.log(`ğŸ”‡ [æ¶ˆæ¯è¿‡æ»¤] å·²è¿‡æ»¤æ¶ˆæ¯ç±»å‹: ${message.type}`);
						}
				}
			} else {
				console.log('âš ï¸ æ¶ˆæ¯æ²¡æœ‰typeå­—æ®µ:');
				console.log('å®Œæ•´æ¶ˆæ¯:', message);
				
				// ä¸æ˜¾ç¤ºæ²¡æœ‰typeçš„æ¶ˆæ¯ï¼ˆé€šå¸¸è¿™äº›æ¶ˆæ¯ä¹Ÿä¸é‡è¦ï¼‰
				// appendStatusMessage(`âš ï¸ æ”¶åˆ°æ— ç±»å‹æ¶ˆæ¯: ${JSON.stringify(message)}`, 'warn');
			}
			
			console.log('========================================');
		}
		
		// æ¨æµçŠ¶æ€
		let isPublishing = false;
		
		// ç»‘å®š"æŒ‰ä½å¼€å§‹å¯¹è®²"æŒ‰é’®äº‹ä»¶
		function setupVoiceButton() {
			const voiceBtn = document.querySelector('.voice-btn');
			if (!voiceBtn) return;
			
			// é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
			voiceBtn.addEventListener('mousedown', (e) => {
				console.log('ğŸ–±ï¸ [é¼ æ ‡äº‹ä»¶] mousedown - é¼ æ ‡æŒ‰ä¸‹');
				e.preventDefault();
				if (!isPublishing) {
					startPublishingWithButton();
				} else {
					console.log('âš ï¸ [é¼ æ ‡äº‹ä»¶] å·²åœ¨æ¨æµä¸­ï¼Œå¿½ç•¥é‡å¤æŒ‰ä¸‹');
				}
			});
			
			// é¼ æ ‡æ¾å¼€äº‹ä»¶
			voiceBtn.addEventListener('mouseup', (e) => {
				console.log('ğŸ–±ï¸ [é¼ æ ‡äº‹ä»¶] mouseup - é¼ æ ‡æ¾å¼€');
				e.preventDefault();
				if (isPublishing) {
					stopPublishingWithButton();
				} else {
					console.log('âš ï¸ [é¼ æ ‡äº‹ä»¶] æœªåœ¨æ¨æµä¸­ï¼Œå¿½ç•¥æ¾å¼€äº‹ä»¶');
				}
			});
			
			// é¼ æ ‡ç¦»å¼€æŒ‰é’®åŒºåŸŸæ—¶ä¹Ÿåœæ­¢
			voiceBtn.addEventListener('mouseleave', (e) => {
				console.log('ğŸ–±ï¸ [é¼ æ ‡äº‹ä»¶] mouseleave - é¼ æ ‡ç¦»å¼€æŒ‰é’®åŒºåŸŸ');
				if (isPublishing) {
					console.log('   - æ­£åœ¨æ¨æµï¼Œè‡ªåŠ¨åœæ­¢');
					stopPublishingWithButton();
				} else {
					console.log('   - æœªåœ¨æ¨æµï¼Œæ— éœ€å¤„ç†');
				}
			});
			
			// è§¦æ‘¸äº‹ä»¶ï¼ˆç§»åŠ¨ç«¯æ”¯æŒï¼‰
			voiceBtn.addEventListener('touchstart', (e) => {
				console.log('ğŸ‘† [è§¦æ‘¸äº‹ä»¶] touchstart - è§¦æ‘¸å¼€å§‹');
				e.preventDefault();
				if (!isPublishing) {
					startPublishingWithButton();
				} else {
					console.log('âš ï¸ [è§¦æ‘¸äº‹ä»¶] å·²åœ¨æ¨æµä¸­ï¼Œå¿½ç•¥é‡å¤è§¦æ‘¸');
				}
			});
			
			voiceBtn.addEventListener('touchend', (e) => {
				console.log('ğŸ‘† [è§¦æ‘¸äº‹ä»¶] touchend - è§¦æ‘¸ç»“æŸ');
				e.preventDefault();
				if (isPublishing) {
					stopPublishingWithButton();
				} else {
					console.log('âš ï¸ [è§¦æ‘¸äº‹ä»¶] æœªåœ¨æ¨æµä¸­ï¼Œå¿½ç•¥è§¦æ‘¸ç»“æŸ');
				}
			});
		}
		
		// é€šè¿‡æŒ‰é’®å¼€å§‹æ¨æµ
		async function startPublishingWithButton() {
			console.log('========== æŒ‰é’®æŒ‰ä¸‹ï¼šå¼€å§‹æ¨æµ ==========');
			console.log('ğŸ”˜ [æŒ‰é’®äº‹ä»¶] ç”¨æˆ·æŒ‰ä¸‹"æŒ‰ä½å¼€å§‹å¯¹è®²"æŒ‰é’®');
			console.log('   - å½“å‰æ¨æµçŠ¶æ€:', isPublishing);
			
			if (isPublishing) {
				console.log('âš ï¸ [æŒ‰é’®äº‹ä»¶] å·²ç»åœ¨æ¨æµä¸­ï¼Œè·³è¿‡é‡å¤è°ƒç”¨');
				return;
			}
			
			// å¦‚æœæˆ¿é—´ä¿¡æ¯ä¸å­˜åœ¨ï¼Œå°è¯•ä»C++ä¼ å…¥çš„æ•°æ®ä¸­è·å–
			if (!roomInfo && roomId) {
				console.log('ğŸ“‹ [æŒ‰é’®äº‹ä»¶] ä»C++ä¼ å…¥çš„æ•°æ®ä¸­è·å–æˆ¿é—´ä¿¡æ¯...');
				roomInfo = {
					room_id: roomId,
					whip_url: whipUrl,
					whep_url: whepUrl,
					stream_name: streamName,
					group_id: groupId
				};
				console.log('   - æˆ¿é—´ä¿¡æ¯å·²æ›´æ–°:', roomInfo);
			}
			
			// å¦‚æœWebSocketæœªè¿æ¥ï¼Œå…ˆè¿æ¥
			if (!ws || ws.readyState !== WebSocket.OPEN) {
				console.log('ğŸ”Œ [æŒ‰é’®äº‹ä»¶] WebSocketæœªè¿æ¥ï¼Œæ­£åœ¨è¿æ¥...');
				connectWebSocket();
				// ç­‰å¾…WebSocketè¿æ¥æˆåŠŸ
				await new Promise((resolve, reject) => {
					let attempts = 0;
					const maxAttempts = 50; // æœ€å¤šç­‰å¾…5ç§’
					const checkConnection = () => {
						attempts++;
						if (ws && ws.readyState === WebSocket.OPEN) {
							console.log(`âœ… [æŒ‰é’®äº‹ä»¶] WebSocketè¿æ¥æˆåŠŸï¼ˆç­‰å¾…äº† ${attempts * 100}msï¼‰`);
							resolve();
						} else if (attempts >= maxAttempts) {
							reject(new Error('WebSocketè¿æ¥è¶…æ—¶'));
						} else {
							setTimeout(checkConnection, 100);
						}
					};
					checkConnection();
				}).catch(error => {
					console.error('========== æŒ‰é’®äº‹ä»¶ï¼šWebSocketè¿æ¥å¤±è´¥ ==========');
					console.error('âŒ [æŒ‰é’®äº‹ä»¶] WebSocketè¿æ¥å¤±è´¥:');
					console.error('   - é”™è¯¯ç±»å‹:', error.name);
					console.error('   - é”™è¯¯æ¶ˆæ¯:', error.message);
					appendStatusMessage('âŒ WebSocketè¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚', 'error');
					// æ¢å¤æŒ‰é’®çŠ¶æ€
					const voiceBtn = document.querySelector('.voice-btn');
					if (voiceBtn) {
						voiceBtn.classList.remove('active');
					}
					isPublishing = false;
					console.log('========== æŒ‰é’®äº‹ä»¶å¤„ç†å®Œæˆ ==========');
					return;
				});
			} else {
				console.log('âœ… [æŒ‰é’®äº‹ä»¶] WebSocketå·²è¿æ¥ï¼ŒçŠ¶æ€:', ws.readyState);
			}
			
			// æ›´æ–°æŒ‰é’®çŠ¶æ€
			const voiceBtn = document.querySelector('.voice-btn');
			if (voiceBtn) {
				voiceBtn.classList.add('active');
				console.log('âœ… [æŒ‰é’®äº‹ä»¶] æŒ‰é’®çŠ¶æ€å·²æ›´æ–°ä¸º active');
			}
			
			isPublishing = true;
			console.log('âœ… [æŒ‰é’®äº‹ä»¶] æ¨æµçŠ¶æ€å·²è®¾ç½®ä¸º true');
			await startPublishing();
		}
		
		// é€šè¿‡æŒ‰é’®åœæ­¢æ¨æµ
		function stopPublishingWithButton() {
			console.log('========== æŒ‰é’®æ¾å¼€ï¼šåœæ­¢æ¨æµ ==========');
			console.log('ğŸ”˜ [æŒ‰é’®äº‹ä»¶] ç”¨æˆ·æ¾å¼€"æŒ‰ä½å¼€å§‹å¯¹è®²"æŒ‰é’®');
			console.log('   - å½“å‰æ¨æµçŠ¶æ€:', isPublishing);
			
			if (!isPublishing) {
				console.log('âš ï¸ [æŒ‰é’®äº‹ä»¶] å½“å‰æœªåœ¨æ¨æµï¼Œæ— éœ€åœæ­¢');
				return;
			}
			
			// æ›´æ–°æŒ‰é’®çŠ¶æ€
			const voiceBtn = document.querySelector('.voice-btn');
			if (voiceBtn) {
				voiceBtn.classList.remove('active');
				console.log('âœ… [æŒ‰é’®äº‹ä»¶] æŒ‰é’®çŠ¶æ€å·²æ›´æ–°ä¸º inactive');
			}
			
			isPublishing = false;
			console.log('âœ… [æŒ‰é’®äº‹ä»¶] æ¨æµçŠ¶æ€å·²è®¾ç½®ä¸º false');
			
			stopPublishing();
			
			// åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºåœæ­¢ä¿¡æ¯
			appendStatusMessage('ğŸ›‘ å·²åœæ­¢æ¨æµã€‚', 'info');
			console.log('========== æŒ‰é’®äº‹ä»¶å¤„ç†å®Œæˆ ==========');
		}
		
		// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
		window.addEventListener('DOMContentLoaded', () => {
			console.log('========== é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ– ==========');
			console.log('åº”ç”¨æ•°æ®:', appData);
			console.log('å½“å‰ç”¨æˆ·:', currentUser);
			console.log('æˆå‘˜æ•°æ®:', membersData);
			console.log('æˆå‘˜æ•°é‡:', membersData ? membersData.length : 0);
			
			// æ£€æŸ¥æ¯ä¸ªæˆå‘˜æ˜¯å¦æœ‰å¤´åƒ
			if (membersData && Array.isArray(membersData)) {
				membersData.forEach((member, index) => {
					console.log(`æˆå‘˜ ${index + 1}:`, {
						id: member.id,
						name: member.name,
						avatar: member.avatar,
						æœ‰å¤´åƒ: !!member.avatar,
						å¤´åƒç±»å‹: typeof member.avatar
					});
				});
			}
			
			// æ£€æŸ¥æ˜¯å¦æœ‰æˆ¿é—´ä¿¡æ¯ï¼Œå¦‚æœæœ‰åˆ™å°è¯•å¼€å§‹æ‹‰æµï¼ˆå»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿WebSocketè¿æ¥åå†æ‹‰æµï¼‰
			if (appData.temp_room && appData.temp_room.whep_url) {
				console.log('ğŸ” [é¡µé¢åŠ è½½] æ£€æµ‹åˆ°æ‹‰æµåœ°å€ï¼Œå°†åœ¨WebSocketè¿æ¥åå¼€å§‹æ‹‰æµ');
				console.log('   - æ‹‰æµåœ°å€:', appData.temp_room.whep_url);
			}
			
			// æ¸²æŸ“å‚ä¸è€…åˆ—è¡¨
			renderParticipants();
			
			// ç»‘å®š"æŒ‰ä½å¼€å§‹å¯¹è®²"æŒ‰é’®äº‹ä»¶
			setupVoiceButton();
			
			// è¿æ¥WebSocketï¼ˆä½†ä¸è‡ªåŠ¨å¼€å§‹æ¨æµï¼Œç­‰å¾…ç”¨æˆ·æŒ‰ä¸‹æŒ‰é’®ï¼‰
			connectWebSocket();
		});
		
		// é¡µé¢å…³é—­å‰å…³é—­WebSocketè¿æ¥å’ŒéŸ³é¢‘æ¨æµ
		window.addEventListener('beforeunload', () => {
			// åœæ­¢éŸ³é¢‘æ¨æµ
			if (publishPc) {
				publishPc.close();
				publishPc = null;
			}
			
			// åœæ­¢åª’ä½“æµï¼ˆé¡µé¢å…³é—­æ—¶æ‰åœæ­¢ï¼‰
			if (publishStream) {
				publishStream.getTracks().forEach(t => t.stop());
				publishStream = null;
			}
			
			// åœæ­¢æ‹‰æµ
			stopPullStream();
			
			// å…³é—­WebSocketè¿æ¥
			if (ws) {
				ws.close();
			}
		});
	</script>
</body>
</html>

