<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>çº¯éŸ³é¢‘ WHIP/WHEP ç§’è¿æµ‹è¯•</title>
</head>
<body>
<h3>çº¯éŸ³é¢‘ç›´æ’­å¿«é€Ÿæµ‹è¯•</h3>
<button id="btnPublish">å¼€å§‹æ¨é€éŸ³é¢‘å¹¶æ’­æ”¾</button>
<br><br>
<audio id="audioPlayer" autoplay controls></audio>

<script>
// SRSé…ç½®
const BASE = 'https://47.100.126.194'; // æ”¹æˆä½ çš„å…¬ç½‘IPæˆ–åŸŸå+HTTPS
const APP = 'live';
const STREAM = 'audio_' + Date.now();
const WHIP_URL = `${BASE}/rtc/v1/whip/?app=${APP}&stream=${STREAM}`;
const WHEP_URL = `${BASE}/rtc/v1/whep/?app=${APP}&stream=${STREAM}`;

// å¯ä»¥æµ‹è¯•å…ˆç”¨ç©ºæ•°ç»„ç¦ç”¨ STUNï¼Œé¿å…å¤–ç½‘è¶…æ—¶
const iceServers = []; 
// å¦‚æœå…¬ç½‘è®¿é—®éœ€è¦ NAT æ‰“æ´æ‰æˆåŠŸï¼Œå°±æ”¹æˆ stun.l.google.com
// const iceServers = [{ urls: ['stun:stun.l.google.com:19302'] }];

// å¯ç”¨ trickle ICEï¼šå‘é€å€™é€‰ç»™ SRS
function setupTrickle(pc, sdpType, url) {
    pc.onicecandidate = async e => {
        if (e.candidate) {
            console.log(`Trickle ICE >>> ${sdpType} candidate:`, e.candidate.candidate);
            // WHIP/WHEP trickle å‘é€æ–¹å¼ï¼š
            // SRS 7.x æ”¯æŒ PATCH /rtc/v1/{whip/whep}/ 
            // ä½ å¯ä»¥æŒ‰éœ€å®ç°å‘é€å€™é€‰çš„ HTTP è¯·æ±‚
        }
    };
}

// æ¨éŸ³é¢‘ (WHIP)
async function whipPublishAudio() {
    console.log("ğŸ“¤ å¼€å§‹ WHIP éŸ³é¢‘æ¨æµ...");
    const pc = new RTCPeerConnection({ iceServers, sdpSemantics: 'unified-plan' });
    setupTrickle(pc, 'publish', WHIP_URL);

    const stream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
    stream.getTracks().forEach(track => pc.addTrack(track, stream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    // ä¸ç­‰ ICE å®Œæˆï¼Œç«‹å³å‘é€ SDP
    const res = await fetch(WHIP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/sdp' },
        body: pc.localDescription.sdp
    });
    if (!res.ok) throw new Error('WHIP é”™è¯¯: ' + res.status);

    const answerSdp = await res.text();
    await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });

    console.log("âœ… WHIP æ¨æµç«¯æ¡æ‰‹å·²å®Œæˆ");
    window._pubPc = pc;
}

// æ’­éŸ³é¢‘ (WHEP)
async function whepPlayAudio() {
    console.log("ğŸ“¥ å¼€å§‹ WHEP éŸ³é¢‘æ’­æ”¾...");
    const pc = new RTCPeerConnection({ iceServers, sdpSemantics: 'unified-plan' });
    setupTrickle(pc, 'play', WHEP_URL);

    pc.ontrack = event => {
        console.log("ğŸ§ æ”¶åˆ°éŸ³é¢‘è½¨é“", event.streams);
        const audioElem = document.getElementById('audioPlayer');
        if (!audioElem.srcObject) {
            audioElem.srcObject = event.streams[0];
        }
    };

    pc.addTransceiver('audio', { direction: 'recvonly' });

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    // ä¸ç­‰ ICE å®Œæˆï¼Œç«‹å³å‘é€ SDP
    const res = await fetch(WHEP_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/sdp' },
        body: pc.localDescription.sdp
    });
    if (!res.ok) throw new Error('WHEP é”™è¯¯: ' + res.status);

    const answerSdp = await res.text();
    await pc.setRemoteDescription({ type: 'answer', sdp: answerSdp });

    console.log("âœ… WHEP æ’­æ”¾ç«¯æ¡æ‰‹å·²å®Œæˆ");
    window._subPc = pc;
}

// æŒ‰é’®äº‹ä»¶ï¼šæ¨æµæˆåŠŸåç«‹åˆ»æ’­æ”¾
document.getElementById('btnPublish').onclick = async () => {
    try {
        await whipPublishAudio();
        await whepPlayAudio();  // ç§’å¼€æ’­æ”¾
    } catch (e) {
        console.error('âŒ æ“ä½œå¤±è´¥', e);
        alert('å¤±è´¥ï¼š' + e.message);
    }
};
</script>
</body>
</html>
